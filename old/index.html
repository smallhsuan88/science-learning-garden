<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è‡ªç„¶ç§‘å­¸ç¿’èŠ±åœ’</title>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; overflow: hidden; }
    .animate-bounce-slow { animation: bounce 3s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
  </style>
</head>

<body>
  <div id="root">
    <div class="flex items-center justify-center h-screen bg-white">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
        <p class="text-gray-500 font-bold">æ­£åœ¨æº–å‚™å–¬å–¬çš„å°èŠ±åœ’...</p>
      </div>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- SVG icons ---
    const IconDroplets = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16.3c2.2 0 4-1.8 4-4 0-3.3-4-6-4-6s-4 2.7-4 6c0 2.2 1.8 4 4 4Z"/><path d="M17 16.3c2.2 0 4-1.8 4-4 0-3.3-4-6-4-6s-4 2.7-4 6c0 2.2 1.8 4 4 4Z"/></svg>;
    const IconSun = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg>;
    const IconZap = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>;
    const IconHome = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
    const IconSprout = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M7 20h10"/><path d="M10 20c5.5-2.5 8-6.4 8-10"/><path d="M14 20c-5.5-2.5-8-6.4-8-10"/><path d="M12 20V9"/><path d="M12 9a4 4 0 0 1 8-4h-8a4 4 0 0 0-8 4h8Z"/></svg>;
    const IconChart = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>;

    const stageEmoji = (stage) => (
      stage === 'sprout' ? 'ğŸŒ±' :
      stage === 'growth' ? 'ğŸŒ¿' :
      stage === 'flower' ? 'ğŸŒ»' : 'ğŸ'
    );

    const App = () => {
      const [view, setView] = useState('dashboard');
      const [isLoading, setIsLoading] = useState(true);
      const [loadError, setLoadError] = useState(null);

      const [user, setUser] = useState(null);
      const [questions, setQuestions] = useState([]);
      const [plants, setPlants] = useState([]);

      const [quizState, setQuizState] = useState({ active: false, currentIdx: 0, questions: [], results: [], streak: 0 });
      const [showFeedback, setShowFeedback] = useState(null);

      // åˆå§‹åŒ–
      useEffect(() => {
        if (!google?.script?.run) {
          setLoadError('æ‰¾ä¸åˆ° google.script.runï¼Œè«‹ç¢ºèªä½ æ˜¯ç”¨ Web App ç¶²å€é–‹å•Ÿï¼ˆä¸æ˜¯ç›´æ¥é–‹ HTMLï¼‰ã€‚');
          setIsLoading(false);
          return;
        }

        google.script.run
          .withFailureHandler(err => {
            console.error(err);
            setLoadError('å¾Œç«¯å‘¼å«å¤±æ•—ï¼š' + (err?.message || JSON.stringify(err)));
            setIsLoading(false);
          })
          .withSuccessHandler(data => {
            console.log('getAppData:', data);

            if (!data || data.status !== 'success') {
              setLoadError((data?.message || 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ˆæœªçŸ¥åŸå› ï¼‰') + (data?.debug ? '\n\nDebug: ' + JSON.stringify(data.debug, null, 2) : ''));
              setIsLoading(false);
              return;
            }

            const u = data.user;
            const cleanUser = {
              ...u,
              resources: {
                water: Number(u.water || 0),
                sunlight: Number(u.sunlight || 0),
                fertilizer: Number(u.fertilizer || 0)
              },
              streak: Number(u.streak || 0)
            };

            const plant0 = (data.plants && data.plants.length) ? data.plants[0] : { plant_id:'p1', seed_type:'æœªå‘½å', growth_points:0, stage:'sprout' };

            setUser(cleanUser);
            setQuestions(Array.isArray(data.questions) ? data.questions : []);
            setPlants([plant0]);
            setIsLoading(false);
          })
          .getAppData();
      }, []);

      const syncWithGAS = useCallback((updatedUser, updatedPlant) => {
        if (!google?.script?.run) return;
        google.script.run
          .withFailureHandler(err => console.error('saveProgress failed:', err))
          .saveProgress({ user: updatedUser, plant: updatedPlant });
      }, []);

      const startQuiz = () => {
        const pool = Array.isArray(questions) ? questions : [];
        const shuffled = [...pool].sort(() => 0.5 - Math.random()).slice(0, 5);

        if (!shuffled.length) {
          alert("é¡Œåº«ç›®å‰æ˜¯ç©ºçš„å–”ï¼");
          return;
        }
        setQuizState({ active: true, currentIdx: 0, questions: shuffled, results: [], streak: user.streak });
        setShowFeedback(null);
        setView('quiz');
      };

      const handleAnswer = (optionIdx) => {
        const currentQ = quizState.questions[quizState.currentIdx];
        const isCorrect = Number(optionIdx) === Number(currentQ.answer_key);
        const newStreak = isCorrect ? (Number(user.streak) || 0) + 1 : 0;

        setShowFeedback({ isCorrect, explanation: currentQ.explanation || '' });

        // log
        google.script.run
          .withFailureHandler(err => console.error('logAnswer failed:', err))
          .logAnswer({
            user_id: user.user_id,
            q_id: currentQ.question_id,
            is_correct: isCorrect,
            chosen_answer: optionIdx
          });

        const newUser = {
          ...user,
          streak: newStreak,
          resources: { ...user.resources }
        };

        if (isCorrect) {
          newUser.resources.water += 1;
          if (newStreak % 3 === 0 && newStreak > 0) newUser.resources.sunlight += 1;
        } else {
          // ä½ ä¹Ÿå¯ä»¥åœ¨é€™è£¡è¨­è¨ˆï¼šç­”éŒ¯çµ¦ä¸€é»è‚¥æ–™ä½œç‚ºé¼“å‹µ
          // newUser.resources.fertilizer += 1;
        }

        setUser(newUser);
        syncWithGAS(newUser, plants[0]);

        setQuizState(prev => ({
          ...prev,
          results: [...prev.results, { isCorrect }],
          streak: newStreak
        }));
      };

      const applyResource = (type) => {
        if (!plants[0]) return;
        if ((user.resources[type] || 0) <= 0) return;

        const boost = type === 'water' ? 2 : type === 'sunlight' ? 5 : 10;
        const currentPoints = Number(plants[0].growth_points || 0);
        const newPoints = Math.min(100, currentPoints + boost);

        let newStage = 'sprout';
        if (newPoints >= 100) newStage = 'fruit';
        else if (newPoints > 70) newStage = 'flower';
        else if (newPoints > 30) newStage = 'growth';

        const updatedPlant = { ...plants[0], growth_points: newPoints, stage: newStage };
        const newUser = { ...user, resources: { ...user.resources, [type]: (user.resources[type] || 0) - 1 } };

        setUser(newUser);
        setPlants([updatedPlant]);
        syncWithGAS(newUser, updatedPlant);
      };

      // Loading / Error UI
      if (isLoading) {
        return <div className="h-screen flex items-center justify-center text-gray-500">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>;
      }

      if (loadError) {
        return (
          <div className="h-screen flex items-center justify-center bg-gray-50 p-6">
            <div className="max-w-xl w-full bg-white border rounded-2xl p-6 shadow">
              <div className="text-xl font-bold text-red-600 mb-2">è³‡æ–™å°šæœªå°±ç·’</div>
              <div className="text-sm text-gray-600 whitespace-pre-wrap">
                {loadError}
              </div>
              <div className="mt-4 text-xs text-gray-500">
                å°æç¤ºï¼šæœ€å¸¸è¦‹åŸå› æ˜¯ Apps Script æ²’æœ‰æŒ‡åˆ°æ­£ç¢ºçš„ Spreadsheetï¼ˆè«‹åœ¨ Code.gs è¨­å®š SPREADSHEET_IDï¼‰ã€‚
              </div>
            </div>
          </div>
        );
      }

      const plant = plants[0];

      return (
        <div className="max-w-md mx-auto h-screen bg-white flex flex-col shadow-xl overflow-hidden">
          <header className="bg-white p-4 border-b flex justify-between items-center shrink-0">
            <h1 className="font-bold text-green-600 text-lg">è‡ªç„¶å°ç©å®¶</h1>
            <div className="text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-bold">
              {user.nickname} çš„ç¨®æ¤ç´€éŒ„
            </div>
          </header>

          <main className="flex-1 overflow-y-auto bg-gray-50">
            {view === 'dashboard' && (
              <div className="p-4 space-y-4">
                <div className="bg-green-600 rounded-3xl p-6 text-white shadow-lg">
                  <h2 className="text-xl font-bold">ä»Šæ—¥èƒ½é‡ç‹€æ…‹</h2>
                  <div className="mt-6 flex gap-4">
                    <div className="flex-1 bg-white/10 p-3 rounded-2xl text-center">
                      <div className="flex justify-center mb-1 text-blue-200"><IconDroplets/></div>
                      <span className="text-lg font-bold">{user.resources.water}</span>
                    </div>
                    <div className="flex-1 bg-white/10 p-3 rounded-2xl text-center">
                      <div className="flex justify-center mb-1 text-yellow-200"><IconSun/></div>
                      <span className="text-lg font-bold">{user.resources.sunlight}</span>
                    </div>
                    <div className="flex-1 bg-white/10 p-3 rounded-2xl text-center">
                      <div className="flex justify-center mb-1 text-purple-200"><IconZap/></div>
                      <span className="text-lg font-bold">{user.resources.fertilizer}</span>
                    </div>
                  </div>
                </div>

                <button onClick={startQuiz} className="w-full bg-white border-2 border-green-500 text-green-600 py-4 rounded-2xl font-bold shadow-sm active:scale-95 transition-all">
                  âš¡ é€²å…¥æ¸¬é©—ç²å–è³‡æº
                </button>

                <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                  <div className="flex items-center gap-4">
                    <div className="text-4xl">{stageEmoji(plant.stage)}</div>
                    <div className="flex-1">
                      <p className="font-bold text-gray-800">{plant.seed_type}</p>
                      <div className="w-full bg-gray-100 h-2 rounded-full mt-2">
                        <div className="bg-green-500 h-2 rounded-full transition-all duration-1000" style={{width: `${plant.growth_points}%`}}></div>
                      </div>
                      <div className="text-xs text-gray-400 mt-2">æˆé•·å€¼ï¼š{plant.growth_points}%</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {view === 'quiz' && quizState.questions.length > 0 && (
              <div className="p-4 flex flex-col h-full">
                <div className="bg-white p-6 rounded-3xl shadow-md border border-gray-100 flex-1 flex flex-col">
                  <p className="text-xs text-blue-500 font-bold mb-2">
                    å–®å…ƒï¼š{quizState.questions[quizState.currentIdx].unit || 'æœªåˆ†é¡'}
                  </p>

                  <h3 className="text-lg font-bold text-gray-800 mb-8 leading-relaxed">
                    {quizState.questions[quizState.currentIdx].stem}
                  </h3>

                  <div className="space-y-3">
                    {(quizState.questions[quizState.currentIdx].options || []).map((opt, i) => (
                      <button
                        key={i}
                        disabled={!!showFeedback}
                        onClick={() => handleAnswer(i)}
                        className={`w-full p-4 rounded-2xl text-left border-2 transition-all ${
                          showFeedback
                            ? i === Number(quizState.questions[quizState.currentIdx].answer_key)
                              ? 'border-green-500 bg-green-50 text-green-700 font-bold'
                              : 'border-gray-50 text-gray-300'
                            : 'border-gray-100 hover:border-green-500 active:bg-gray-50 text-gray-700'
                        }`}
                      >
                        {i+1}. {opt}
                      </button>
                    ))}
                  </div>

                  {showFeedback && (
                    <div className="mt-auto pt-6 border-t border-dashed">
                      <p className={`text-sm font-bold ${showFeedback.isCorrect ? 'text-green-600' : 'text-red-500'} mb-2`}>
                        {showFeedback.isCorrect ? 'âœ… ç­”å°äº†ï¼' : 'âŒ å¯æƒœç­”éŒ¯äº†ï¼Œçœ‹è§£æå­¸ç¿’å§'}
                      </p>
                      <p className="text-xs text-gray-500 mb-4">{showFeedback.explanation}</p>

                      <button
                        onClick={() => {
                          setShowFeedback(null);
                          if (quizState.currentIdx + 1 < quizState.questions.length) {
                            setQuizState(p => ({...p, currentIdx: p.currentIdx + 1}));
                          } else {
                            setView('dashboard');
                          }
                        }}
                        className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg"
                      >
                        {quizState.currentIdx + 1 < quizState.questions.length ? 'ä¸‹ä¸€é¡Œ' : 'è¿”å›èŠ±åœ’'}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            )}

            {view === 'garden' && (
              <div className="p-4 h-full flex flex-col items-center justify-center space-y-12">
                <div className="text-[100px] animate-bounce-slow drop-shadow-lg">{stageEmoji(plant.stage)}</div>
                <div className="flex gap-8">
                  <button onClick={() => applyResource('water')} className="flex flex-col items-center gap-2">
                    <div className="bg-white p-5 rounded-3xl shadow-md text-blue-500 active:scale-90 transition-all border border-blue-50"><IconDroplets/></div>
                    <span className="text-sm font-bold text-gray-500">{user.resources.water}</span>
                  </button>
                  <button onClick={() => applyResource('sunlight')} className="flex flex-col items-center gap-2">
                    <div className="bg-white p-5 rounded-3xl shadow-md text-yellow-500 active:scale-90 transition-all border border-yellow-50"><IconSun/></div>
                    <span className="text-sm font-bold text-gray-500">{user.resources.sunlight}</span>
                  </button>
                  <button onClick={() => applyResource('fertilizer')} className="flex flex-col items-center gap-2">
                    <div className="bg-white p-5 rounded-3xl shadow-md text-purple-500 active:scale-90 transition-all border border-purple-50"><IconZap/></div>
                    <span className="text-sm font-bold text-gray-500">{user.resources.fertilizer}</span>
                  </button>
                </div>
              </div>
            )}

            {view === 'progress' && (
              <div className="p-6 space-y-6">
                <h2 className="text-xl font-bold text-gray-800">æˆé•·é€±å ±è¡¨</h2>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-blue-50 p-6 rounded-3xl border border-blue-100 text-center">
                    <p className="text-xs text-blue-600 font-bold mb-1">ç›®å‰é€£å‹</p>
                    <p className="text-3xl font-bold text-blue-800">{user.streak}</p>
                  </div>
                  <div className="bg-green-50 p-6 rounded-3xl border border-green-100 text-center">
                    <p className="text-xs text-green-600 font-bold mb-1">æ¤ç‰©èƒ½é‡</p>
                    <p className="text-3xl font-bold text-green-800">{plant.growth_points}%</p>
                  </div>
                </div>
              </div>
            )}
          </main>

          <nav className="bg-white border-t p-4 flex justify-around shrink-0 shadow-inner">
            <button onClick={() => setView('dashboard')} className={view === 'dashboard' ? 'text-green-600' : 'text-gray-300'}><IconHome/></button>
            <button onClick={() => setView('garden')} className={view === 'garden' ? 'text-green-600' : 'text-gray-300'}><IconSprout/></button>
            <button onClick={() => setView('progress')} className={view === 'progress' ? 'text-green-600' : 'text-gray-300'}><IconChart/></button>
          </nav>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
