<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science Learning Garden</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-2xl font-semibold">ğŸŒ± Science Learning Garden</h1>
      <p class="text-slate-300 mt-2">GitHub Pages å‰ç«¯ Ã— Google Apps Script API Ã— Google Sheet é¡Œåº«</p>
    </header>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-300 mb-1">ä½¿ç”¨è€… ID</label>
          <input id="user_id" value="u001"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å¹´ç´š (grade)</label>
          <input id="grade" placeholder="ä¾‹å¦‚ 3"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å–®å…ƒ (unit)</label>
          <input id="unit" placeholder="ä¾‹å¦‚ æ¤ç‰©çš„æ§‹é€ "
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">é›£åº¦ (difficulty)</label>
          <input id="difficulty" placeholder="Normal"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div class="flex items-end gap-2">
          <button id="btnPing"
            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">
            Ping API
          </button>
          <button id="btnLoad"
            class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-medium">
            è¼‰å…¥é¡Œç›®
          </button>
        </div>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-300"></div>
      <div class="mt-2 text-xs text-slate-400 break-all">
        API_BASEï¼š<span id="apiBaseText"></span>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6"></section>

    <!-- List -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">é¡Œç›®æ¸…å–®</h2>
        <div id="count" class="text-sm text-slate-300"></div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
    </section>
  </div>

<script>
/* =========================================================
   âœ… ç©©å®šå…¥å£ï¼šscript.googleusercontent.comï¼ˆä¸æ€•é‡æ–°éƒ¨ç½²ï¼‰
========================================================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbyouH4rIopFTOQIPcoKosIFIwwd3wi9kvernE3D7lVWuFZp8BCoG8bC6fwIrsFUEVAF/exec";

/* ========================================================= */

const $ = (id) => document.getElementById(id);
$("apiBaseText").textContent = API_BASE;

let questions = [];

function setStatus(msg, isError = false) {
  $("status").textContent = msg;
  $("status").className = "mt-3 text-sm " + (isError ? "text-rose-300" : "text-slate-300");
}

function formatError(err) {
  if (!err) return "æœªçŸ¥éŒ¯èª¤";
  if (err.httpStatus) return `HTTP ${err.httpStatus}ï¼š${err.message}`;
  return err.message || String(err);
}

async function callApi({ method = "GET", action, query = {}, payload } = {}) {
  const url = new URL(API_BASE);
  if (action) url.searchParams.set("action", action);
  Object.entries(query).forEach(([k, v]) => {
    if (v !== "" && v !== undefined && v !== null) url.searchParams.set(k, v);
  });

  let res;
  try {
    res = await fetch(url.toString(), {
      method,
      headers: method === "POST" ? { "Content-Type": "application/json" } : undefined,
      body: method === "POST" ? JSON.stringify(payload || {}) : undefined,
    });
  } catch (e) {
    throw new Error("ç„¡æ³•é€£ç·šåˆ° APIï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Web App æ¬Šé™ï¼ˆ" + e.message + "ï¼‰");
  }

  const text = await res.text();
  let json;
  try {
    json = text ? JSON.parse(text) : {};
  } catch (e) {
    const hint = text.slice(0, 160) || "ï¼ˆç©ºç™½å›æ‡‰ï¼‰";
    const err = new Error("API å›æ‡‰ä¸æ˜¯ JSONï¼š" + hint);
    err.httpStatus = res.status;
    throw err;
  }

  if (!res.ok) {
    const msg = json.error || json.message || res.statusText;
    const err = new Error(msg);
    err.httpStatus = res.status;
    throw err;
  }

  if (json.ok === false || json.status === "error") {
    const msg = json.message || json.error || "API å›å‚³éŒ¯èª¤";
    const err = new Error(msg);
    err.httpStatus = json.code || "";
    throw err;
  }
  return json;
}

function firstArrayCandidate(obj, paths) {
  for (const path of paths) {
    let cur = obj;
    let ok = true;
    for (const key of path) {
      if (cur && Object.prototype.hasOwnProperty.call(cur, key)) {
        cur = cur[key];
      } else {
        ok = false;
        break;
      }
    }
    if (ok && Array.isArray(cur)) return cur;
  }
  return [];
}

function normalizeQuestionList(resp) {
  const safeResp = resp ?? {};
  const listSource = Array.isArray(safeResp)
    ? safeResp
    : firstArrayCandidate(safeResp, [
        ["data"],
        ["questions"],
        ["items"],
        ["data", "questions"],
        ["data", "items"],
      ]);

  const normalized = listSource.map(normalizeQuestion);
  const count =
    safeResp.count ??
    safeResp.total ??
    safeResp.total_count ??
    safeResp.data?.count ??
    normalized.length;

  return { items: normalized, count };
}

function normalizeQuestion(q) {
  const optionsRaw = Array.isArray(q.options)
    ? q.options
    : String(q.options ?? q.choices ?? "")
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);

  const questionId = q.question_id ?? q.q_id ?? q.id ?? q.uuid ?? "";

  return {
    ...q,
    question_id: questionId,
    stem: q.stem ?? q.question ?? q.title ?? "",
    unit: q.unit ?? q.topic ?? q.category ?? "",
    difficulty: q.difficulty ?? q.level ?? "",
    options: optionsRaw,
  };
}

function pickOne() {
  return questions[Math.floor(Math.random() * questions.length)];
}

function renderList(items) {
  $("list").innerHTML = "";
  $("count").textContent = items.length
    ? `å…± ${items.length} é¡Œï¼ˆç›®å‰é¡¯ç¤ºï¼‰`
    : "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®";

  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "text-slate-400 text-sm";
    empty.textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ã€‚è«‹èª¿æ•´ç¯©é¸æ¢ä»¶å¾Œå†è©¦ä¸€æ¬¡ã€‚";
    $("list").appendChild(empty);
    $("quiz").classList.add("hidden");
    $("quiz").innerHTML = "";
    return;
  }

  items.forEach((q) => {
    const card = document.createElement("div");
    card.className = "p-4 border border-slate-800 rounded bg-slate-950/40";
    card.innerHTML = `
      <div class="font-semibold">${escapeHtml(q.stem || "")}</div>
      <div class="text-sm text-slate-300 mt-1">
        å¹´ç´š ${escapeHtml(String(q.grade ?? ""))}ï½œ${escapeHtml(q.unit || "")}ï½œ${escapeHtml(q.difficulty || "")}
      </div>
      <button class="mt-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600">
        ä½œç­”
      </button>
    `;
    card.querySelector("button").onclick = () => renderQuiz(q);
    $("list").appendChild(card);
  });
}

function renderQuiz(q) {
  const quiz = $("quiz");
  quiz.classList.remove("hidden");

  const opts = (Array.isArray(q.options) ? q.options : [])
    .map((s) => String(s).trim())
    .filter(Boolean);
  const optHtml = opts
    .map(
      (op, i) => `
    <label class="flex gap-2 p-2 border border-slate-800 rounded cursor-pointer">
      <input type="radio" name="opt" value="${i}">
      <span>${escapeHtml(op)}</span>
    </label>
  `
    )
    .join("");

  quiz.innerHTML = `
    <div class="text-xl font-semibold mb-3">${escapeHtml(q.stem || "")}</div>
    <div class="space-y-2">${optHtml || `<div class="text-slate-300">æ­¤é¡Œ options æ¬„ä½æ˜¯ç©ºçš„</div>`}</div>

    <div class="mt-3 flex gap-2">
      <button id="submit" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">é€å‡º</button>
      <button id="next" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">æ›ä¸€é¡Œ</button>
    </div>

    <div id="result" class="mt-3 text-sm"></div>

    <details class="mt-3">
      <summary class="cursor-pointer text-slate-300">è§£æ</summary>
      <div class="mt-2 text-slate-200">${escapeHtml(q.explanation || "")}</div>
    </details>
  `;

  $("next").onclick = () => {
    if (!questions.length) return;
    renderQuiz(pickOne());
  };

  $("submit").onclick = async () => {
    const picked = quiz.querySelector('input[name="opt"]:checked');
    if (!picked) {
      $("result").textContent = "è«‹å…ˆé¸ä¸€å€‹ç­”æ¡ˆ";
      return;
    }

    try {
      $("result").textContent = "é€å‡ºä¸­â€¦";

      const r = await callApi({
        method: "POST",
        action: "submitAnswer",
        payload: {
          user_id: $("user_id").value.trim(),
          q_id: q.question_id,
          chosen_answer: Number(picked.value),
        },
      });

      const ok = !!(r.is_correct ?? r.correct ?? r.ok);
      $("result").textContent = ok ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼";
    } catch (e) {
      $("result").textContent = "é€å‡ºå¤±æ•—ï¼š" + formatError(e);
    }
  };
}

$("btnPing").onclick = async () => {
  try {
    setStatus("Ping ä¸­â€¦");
    const r = await callApi({ method: "GET", query: { action: "ping" } });
    const msg = r.message || r.status || "pong";
    const ts = r.ts ? `ï¼ˆ${r.ts}ï¼‰` : "";
    setStatus(`API OKï¼š${msg}${ts}`);
  } catch (e) {
    setStatus("Ping å¤±æ•—ï¼š" + formatError(e), true);
  }
};

$("btnLoad").onclick = async () => {
  try {
    setStatus("è¼‰å…¥ä¸­â€¦");
    const r = await callApi({
      method: "GET",
      query: {
        action: "getQuestions",
        grade: $("grade").value.trim(),
        unit: $("unit").value.trim(),
        difficulty: $("difficulty").value.trim(),
        limit: 100,
      },
    });

    const parsed = normalizeQuestionList(r);
    questions = parsed.items;
    renderList(questions);

    if (questions.length) renderQuiz(pickOne());
    setStatus(`è¼‰å…¥æˆåŠŸï¼šå…± ${parsed.count} é¡Œ`);
  } catch (e) {
    setStatus("è¼‰å…¥å¤±æ•—ï¼š" + formatError(e), true);
    renderList([]);
  }
};

// é˜² XSSï¼šæŠŠé¡Œç›®æ–‡å­—å®‰å…¨è¼¸å‡º
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>
</body>
</html>
