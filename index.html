<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science Learning Garden</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-2xl font-semibold">ğŸŒ± Science Learning Garden</h1>
      <p class="text-slate-300 mt-2">GitHub Pages å‰ç«¯ Ã— Google Apps Script API Ã— Google Sheet é¡Œåº«</p>
    </header>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-300 mb-1">ä½¿ç”¨è€… ID</label>
          <input id="user_id" value="u001"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å¹´ç´š (grade)</label>
          <input id="grade" placeholder="ä¾‹å¦‚ 3"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å–®å…ƒ (unit)</label>
          <input id="unit" placeholder="ä¾‹å¦‚ æ¤ç‰©çš„æ§‹é€ "
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">é›£åº¦ (difficulty)</label>
          <input id="difficulty" placeholder="ä¾‹å¦‚ Easy / Normal"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div class="flex items-end gap-2">
          <button id="btnPing"
            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">
            Ping API
          </button>
          <button id="btnLoad"
            class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-medium">
            è¼‰å…¥é¡Œç›®
          </button>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap items-center gap-2">
        <button id="btnClearApi"
          class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          æ¸…é™¤ API å¿«å–
        </button>
        <button id="btnRefreshApi"
          class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          é‡æ–°å–å¾—ç©©å®šå…¥å£
        </button>
        <div id="status" class="text-sm text-slate-300"></div>
      </div>

      <div class="mt-2 text-xs text-slate-400 break-all">
        API_BASEï¼ˆå¯¦éš›å‘¼å«ç”¨ï¼‰ï¼š<span id="apiBaseText"></span>
      </div>
      <div class="mt-1 text-xs text-slate-500 break-all">
        FALLBACK_EXECï¼ˆåƒ…ç”¨ä¾†è§£æï¼‰ï¼š<span id="execText"></span>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6"></section>

    <!-- List -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">é¡Œç›®æ¸…å–®</h2>
        <div id="count" class="text-sm text-slate-300"></div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
    </section>
  </div>

<script>
/* =========================================================
   âœ… ç›®æ¨™ï¼šå‰ç«¯åªéœ€è¦å¡«ã€Œexecã€ï¼Œç¨‹å¼æœƒè‡ªå‹•è§£æå‡º
   âœ… ç©©å®šå…¥å£ï¼šscript.googleusercontent.com/macros/echo?...ï¼ˆä¸¦å¿«å–ï¼‰
   âœ… é‡æ–°éƒ¨ç½²å¾Œä½ åªè¦æ› FALLBACK_EXEC ä¸€è¡Œå³å¯
========================================================= */

// ä½ é‡æ–°éƒ¨ç½²å¾Œåªéœ€è¦æ”¹é€™ä¸€è¡Œï¼ˆexec æœƒè®Šï¼‰
const FALLBACK_EXEC = "https://script.google.com/macros/s/AKfycbyouH4rIopFTOQIPcoKosIFIwwd3wi9kvernE3D7lVWuFZp8BCoG8bC6fwIrsFUEVAF/exec";

// localStorage å¿«å– keyï¼ˆåƒ…è¨˜éŒ„ googleusercontent baseï¼‰
const LS_KEY = "SLG_API_BASE_GOOGLEUSERCONTENT";

let API_BASE = "";
let backendCount = 0;

/**
 * è§£æ exec â†’ è‡ªå‹• follow redirect â†’ å–å¾— googleusercontent echo ç©©å®šå…¥å£
 * ä¸¦å­˜åˆ° localStorageï¼Œå¾ŒçºŒ callApi ç›´æ¥ç”¨ç©©å®šå…¥å£ï¼Œä¸å†ä¾è³´ execã€‚
 */
async function refreshStableApiBase() {
  const res = await fetch(`${FALLBACK_EXEC}?action=ping`, { redirect: "follow" });
  const finalUrl = res.url || "";
  if (finalUrl.includes("script.googleusercontent.com")) {
    API_BASE = finalUrl;
    localStorage.setItem(LS_KEY, API_BASE);
    $("apiBaseText").textContent = API_BASE;
    return API_BASE;
  }
  throw new Error("è§£æç©©å®šå…¥å£å¤±æ•—ï¼Œæœªå–å¾— googleusercontent ä½ç½®");
}

function loadApiBaseFromCache() {
  const cached = localStorage.getItem(LS_KEY);
  if (cached && cached.includes("script.googleusercontent.com")) {
    API_BASE = cached;
    $("apiBaseText").textContent = API_BASE;
    return API_BASE;
  }
  return "";
}

async function ensureApiBase() {
  if (API_BASE) return API_BASE;
  const cached = loadApiBaseFromCache();
  if (cached) return cached;
  try {
    return await refreshStableApiBase();
  } catch (e) {
    // è®“ä¸Šå±¤æ±ºå®šå¦‚ä½•è™•ç†
    throw e;
  }
}

function clearApiCache() {
  localStorage.removeItem(LS_KEY);
  API_BASE = "";
}

const $ = (id) => document.getElementById(id);

$("execText").textContent = FALLBACK_EXEC;
$("apiBaseText").textContent = "ï¼ˆå°šæœªè§£æï¼Œè«‹å…ˆæŒ‰ Ping API æˆ– è¼‰å…¥é¡Œç›®ï¼‰";

loadApiBaseFromCache();
ensureApiBase().catch(() => { /* ç­‰æ‰‹å‹• refresh */ });

let questions = [];

function setStatus(msg, isError = false) {
  $("status").textContent = msg;
  $("status").className = "text-sm " + (isError ? "text-rose-300" : "text-slate-300");
}

function formatError(err) {
  if (!err) return "æœªçŸ¥éŒ¯èª¤";
  if (err.httpStatus) return `HTTP ${err.httpStatus}ï¼š${err.message}`;
  return err.message || String(err);
}

function buildUrl(action, query = {}) {
  if (!API_BASE) throw new Error("å°šæœªå–å¾— API_BASE");
  const url = new URL(API_BASE);
  if (action) url.searchParams.set("action", action);
  Object.entries(query).forEach(([k, v]) => {
    if (v !== undefined && v !== null) url.searchParams.set(k, v);
  });
  return url.toString();
}

async function doFetchOnce({ method, action, query, payload }) {
  const url = buildUrl(action, query);
  let res;
  try {
    res = await fetch(url, {
      method,
      headers: method === "POST" ? { "Content-Type": "application/json" } : undefined,
      body: method === "POST" ? JSON.stringify(payload || {}) : undefined,
    });
  } catch (e) {
    const err = new Error("ç„¡æ³•é€£ç·šåˆ° APIï¼š" + e.message);
    err.httpStatus = "";
    throw err;
  }

  const text = await res.text();
  let json;
  try {
    json = text ? JSON.parse(text) : {};
  } catch (e) {
    const hint = text.slice(0, 160) || "ï¼ˆç©ºç™½å›æ‡‰ï¼‰";
    const err = new Error("API å›æ‡‰ä¸æ˜¯ JSONï¼š" + hint);
    err.httpStatus = res.status;
    throw err;
  }

  if (!res.ok) {
    const msg = json.error || json.message || res.statusText;
    const err = new Error(msg);
    err.httpStatus = res.status;
    throw err;
  }

  if (json.ok === false || json.status === "error") {
    const msg = json.message || json.error || "API å›å‚³éŒ¯èª¤";
    const err = new Error(msg);
    err.httpStatus = json.code || "";
    throw err;
  }
  return json;
}

async function callApi({ method = "GET", action, query = {}, payload } = {}) {
  let lastErr;
  for (let attempt = 0; attempt < 2; attempt++) {
    try {
      await ensureApiBase();
      $("apiBaseText").textContent = API_BASE || $("apiBaseText").textContent;
      return await doFetchOnce({ method, action, query, payload });
    } catch (e) {
      lastErr = e;
      if (attempt === 0) {
        try {
          await refreshStableApiBase();
          continue;
        } catch {
          // å¦‚æœ refresh ä¹Ÿå¤±æ•—å°±ç›´æ¥è·³å‡º
        }
      }
      break;
    }
  }
  throw lastErr || new Error("API å‘¼å«å¤±æ•—");
}

function firstArrayCandidate(obj, paths) {
  for (const path of paths) {
    let cur = obj;
    let ok = true;
    for (const key of path) {
      if (cur && Object.prototype.hasOwnProperty.call(cur, key)) {
        cur = cur[key];
      } else {
        ok = false;
        break;
      }
    }
    if (ok && Array.isArray(cur)) return cur;
  }
  return [];
}

function normalizeQuestionList(resp) {
  const safeResp = resp ?? {};
  const listSource = Array.isArray(safeResp)
    ? safeResp
    : firstArrayCandidate(safeResp, [
        ["data"],           // âœ… ä½ çš„ GAS å›å‚³æ˜¯ { ok, count, data:[...] }
        ["questions"],
        ["items"],
        ["data", "questions"],
        ["data", "items"],
      ]);

  const normalized = listSource.map(normalizeQuestion);
  const count =
    safeResp.count ??
    safeResp.total ??
    safeResp.total_count ??
    safeResp.data?.count ??
    normalized.length;

  return { items: normalized, count };
}

function normalizeQuestion(q) {
  const optionsRaw = Array.isArray(q.options)
    ? q.options
    : String(q.options ?? q.choices ?? "")
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);

  const questionId = q.question_id ?? q.q_id ?? q.id ?? q.uuid ?? "";

  return {
    ...q,
    question_id: questionId,
    stem: q.stem ?? q.question ?? q.title ?? "",
    unit: q.unit ?? q.topic ?? q.category ?? "",
    difficulty: q.difficulty ?? q.level ?? "",
    options: optionsRaw,
  };
}

function pickOne() {
  return questions[Math.floor(Math.random() * questions.length)];
}

function renderList(items, totalCount = 0) {
  $("list").innerHTML = "";
  if (items.length) {
    const backendText = totalCount ? `å¾Œç«¯å…± ${totalCount} é¡Œï½œ` : "";
    $("count").textContent = `${backendText}ç›®å‰é¡¯ç¤º ${items.length} é¡Œ`;
  } else {
    $("count").textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®";
  }

  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "text-slate-400 text-sm";
    empty.textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ã€‚è«‹èª¿æ•´ç¯©é¸æ¢ä»¶å¾Œå†è©¦ä¸€æ¬¡ã€‚";
    $("list").appendChild(empty);
    $("quiz").classList.add("hidden");
    $("quiz").innerHTML = "";
    return;
  }

  items.forEach((q) => {
    const card = document.createElement("div");
    card.className = "p-4 border border-slate-800 rounded bg-slate-950/40";
    card.innerHTML = `
      <div class="font-semibold">${escapeHtml(q.stem || "")}</div>
      <div class="text-sm text-slate-300 mt-1">
        å¹´ç´š ${escapeHtml(String(q.grade ?? ""))}ï½œ${escapeHtml(q.unit || "")}ï½œ${escapeHtml(q.difficulty || "")}
      </div>
      <button class="mt-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600">
        ä½œç­”
      </button>
    `;
    card.querySelector("button").onclick = () => renderQuiz(q);
    $("list").appendChild(card);
  });
}

function renderQuiz(q) {
  const quiz = $("quiz");
  quiz.classList.remove("hidden");

  const opts = (Array.isArray(q.options) ? q.options : [])
    .map((s) => String(s).trim())
    .filter(Boolean);

  const optHtml = opts
    .map(
      (op, i) => `
    <label class="flex gap-2 p-2 border border-slate-800 rounded cursor-pointer">
      <input type="radio" name="opt" value="${i}">
      <span>${escapeHtml(op)}</span>
    </label>
  `
    )
    .join("");

  quiz.innerHTML = `
    <div class="text-xl font-semibold mb-3">${escapeHtml(q.stem || "")}</div>
    <div class="space-y-2">${optHtml || `<div class="text-slate-300">æ­¤é¡Œ options æ¬„ä½æ˜¯ç©ºçš„</div>`}</div>

    <div class="mt-3 flex gap-2">
      <button id="submit" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">é€å‡º</button>
      <button id="next" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">æ›ä¸€é¡Œ</button>
    </div>

    <div id="result" class="mt-3 text-sm"></div>

    <details class="mt-3">
      <summary class="cursor-pointer text-slate-300">è§£æ</summary>
      <div class="mt-2 text-slate-200">${escapeHtml(q.explanation || "")}</div>
    </details>
  `;

  $("next").onclick = () => {
    if (!questions.length) return;
    renderQuiz(pickOne());
  };

  $("submit").onclick = async () => {
    const picked = quiz.querySelector('input[name="opt"]:checked');
    if (!picked) {
      $("result").textContent = "è«‹å…ˆé¸ä¸€å€‹ç­”æ¡ˆ";
      return;
    }

    try {
      $("result").textContent = "é€å‡ºä¸­â€¦";

      const r = await callApi({
        method: "POST",
        action: "submitAnswer",
        payload: {
          user_id: $("user_id").value.trim(),
          q_id: q.question_id,
          chosen_answer: Number(picked.value),
        },
      });

      const ok = !!(r.is_correct ?? r.correct ?? r.ok);
      $("result").textContent = ok ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼";
    } catch (e) {
      $("result").textContent = "é€å‡ºå¤±æ•—ï¼š" + formatError(e);
    }
  };
}

$("btnPing").onclick = async () => {
  try {
    setStatus("Ping ä¸­â€¦");
    const r = await callApi({ method: "GET", action: "ping" });
    const msg = r.message || r.status || "pong";
    const ts = r.ts ? `ï¼ˆ${r.ts}ï¼‰` : "";
    setStatus(`API OKï¼š${msg}${ts}`);
  } catch (e) {
    setStatus("Ping å¤±æ•—ï¼š" + formatError(e), true);
  }
};

$("btnLoad").onclick = async () => {
  try {
    setStatus("è¼‰å…¥ä¸­â€¦");

    // âœ… æé†’ï¼šä½ é¡Œåº« difficulty å¤šç‚º Easyï¼Œé è¨­ placeholder åªæ˜¯ç¤ºæ„
    const r = await callApi({
      method: "GET",
      action: "getQuestions",
      query: {
        grade: $("grade").value.trim(),
        unit: $("unit").value.trim(),
        difficulty: $("difficulty").value.trim(),
        limit: 100,
      },
    });

    const parsed = normalizeQuestionList(r);
    questions = parsed.items;
    backendCount = parsed.count ?? questions.length;
    renderList(questions, backendCount);

    if (questions.length) renderQuiz(pickOne());
    setStatus(`è¼‰å…¥æˆåŠŸï¼šå¾Œç«¯å›å‚³ ${backendCount} é¡Œï¼Œå‰ç«¯é¡¯ç¤º ${questions.length} é¡Œ`);
  } catch (e) {
    setStatus("è¼‰å…¥å¤±æ•—ï¼š" + formatError(e), true);
    backendCount = 0;
    renderList([], backendCount);
  }
};

$("btnClearApi").onclick = () => {
  clearApiCache();
  $("apiBaseText").textContent = "ï¼ˆå·²æ¸…é™¤å¿«å–ï¼Œè«‹æŒ‰ Ping API é‡æ–°è§£æï¼‰";
  setStatus("å·²æ¸…é™¤ API å¿«å–ã€‚ä¸‹ä¸€æ¬¡ Ping / è¼‰å…¥é¡Œç›®æœƒé‡æ–°è§£æç©©å®šå…¥å£ã€‚");
};

$("btnRefreshApi").onclick = async () => {
  try {
    setStatus("é‡æ–°è§£æç©©å®šå…¥å£ä¸­â€¦");
    await refreshStableApiBase();
    setStatus("å·²é‡æ–°å–å¾—ç©©å®šå…¥å£");
  } catch (e) {
    setStatus("é‡æ–°å–å¾—ç©©å®šå…¥å£å¤±æ•—ï¼š" + formatError(e), true);
  }
};

// é˜² XSSï¼šæŠŠé¡Œç›®æ–‡å­—å®‰å…¨è¼¸å‡º
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>
</body>
</html>
