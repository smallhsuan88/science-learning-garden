<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science Learning Garden</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-2xl font-semibold">ğŸŒ± Science Learning Garden</h1>
      <p class="text-slate-300 mt-2">GitHub Pages å‰ç«¯ Ã— Google Apps Script API Ã— Google Sheet é¡Œåº«</p>
    </header>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-300 mb-1">ä½¿ç”¨è€… ID</label>
          <input id="user_id" value="u001"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å¹´ç´š (grade)</label>
          <input id="grade" placeholder="ä¾‹å¦‚ 1 / 2 / 3"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å–®å…ƒ (unit)</label>
          <input id="unit" placeholder="ä¾‹å¦‚ æ¤ç‰©çš„æ§‹é€ "
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">é›£åº¦ (difficulty)</label>
          <!-- âœ… é è¨­ç©ºç™½ï¼Œé¿å…ä¸€é–‹å§‹å°±æŠŠé¡Œç›®ç¯©å…‰ -->
          <input id="difficulty" placeholder="ä¾‹å¦‚ Easy / Normal / Hardï¼ˆå¯ç•™ç©ºï¼‰"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div class="flex items-end gap-2">
          <button id="btnPing"
            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">
            Ping API
          </button>
          <button id="btnLoad"
            class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-medium">
            è¼‰å…¥é¡Œç›®
          </button>
          <button id="btnLoadAll"
            class="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 font-medium text-slate-900">
            è¼‰å…¥å…¨éƒ¨ï¼ˆå¿½ç•¥ç¯©é¸ï¼‰
          </button>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnRefreshStable"
          class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          é‡æ–°å–å¾—ç©©å®šå…¥å£
        </button>
        <button id="btnClearCache"
          class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          æ¸…é™¤ API å¿«å–
        </button>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-300"></div>

      <div class="mt-2 text-xs text-slate-400 break-all space-y-1">
        <div>API_BASEï¼ˆå¯¦éš›å‘¼å«ç”¨ï¼‰ï¼š<span id="apiBaseText"></span></div>
        <div>FALLBACK_EXECï¼ˆå‚™æ´ï¼‰ï¼š<span id="execText"></span></div>
        <div>æœ€è¿‘ä¸€æ¬¡è«‹æ±‚ï¼š<span id="lastReq"></span></div>
      </div>
    </section>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <h2 class="text-lg font-semibold mb-2">Debug</h2>
      <div class="text-xs text-slate-300 space-y-2">
        <div>
          <div class="font-medium text-slate-200">Sanitized Query</div>
          <pre id="debugQuery" class="mt-1 whitespace-pre-wrap break-words bg-slate-950/60 rounded p-2 border border-slate-800 text-slate-300">ï¼ˆå°šæœªé€å‡ºæŸ¥è©¢ï¼‰</pre>
        </div>
        <div>
          <div class="font-medium text-slate-200">lastRequestUrl</div>
          <div id="debugLastRequestUrl" class="mt-1 break-all text-slate-400">ï¼ˆå°šæœªé€å‡ºè«‹æ±‚ï¼‰</div>
        </div>
        <div>
          <div class="font-medium text-slate-200">rawResponsePreviewï¼ˆå‰ 300 å­—ï¼‰</div>
          <pre id="debugRaw" class="mt-1 whitespace-pre-wrap break-words bg-slate-950/60 rounded p-2 border border-slate-800 text-slate-300">ï¼ˆå°šæœªé€å‡ºè«‹æ±‚ï¼‰</pre>
        </div>
        <div>
          <div class="font-medium text-slate-200">parsedCount</div>
          <div id="debugParsedCount" class="mt-1 text-slate-400">ï¼ˆå°šæœªè§£æï¼‰</div>
        </div>
        <div>
          <div class="font-medium text-slate-200">written_to_spreadsheet_id</div>
          <div id="debugSheetId" class="mt-1 break-all text-slate-400">ï¼ˆå°šæœªå¯«å…¥ï¼‰</div>
        </div>
      </div>
    </section>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="space-y-1 text-sm text-slate-200">
          <div>ç¸½é¡Œæ•¸ï¼š<span id="progressTotal">-</span></div>
          <div>æœ¬æ¬¡å·²å®Œæˆï¼š<span id="progressSession">0</span></div>
          <div>ç´¯ç©å·²å®Œæˆï¼š<span id="progressLifetime">-</span></div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="btnSaveProgress" class="px-4 py-2 rounded bg-emerald-700 hover:bg-emerald-600 text-sm">å®Œæˆæœ¬æ¬¡ï¼ˆä¿å­˜é€²åº¦ï¼‰</button>
          <button id="btnResetProgress" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">é‡æ–°é–‹å§‹ï¼ˆæ¸…ç©ºé€²åº¦ï¼‰</button>
        </div>
      </div>
      <div id="progressHint" class="text-xs text-slate-400 mt-2"></div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6"></section>

    <!-- List -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">é¡Œç›®æ¸…å–®</h2>
        <div id="count" class="text-sm text-slate-300"></div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
    </section>
  </div>

<script>
/* =========================================================
   âœ… è¨­å®š API å…¥å£ï¼šå…ˆ googleusercontentã€å† exec å‚™æ´
========================================================= */
const API_GOOGLEUSERCONTENT_BASE = "";
const API_EXEC_FALLBACK = "https://script.google.com/macros/s/AKfycbya27B-Xrr1nZzwT6c2eWNrPjMLbuc1nKF70ikVqGtaiZn7XQ5B37uhuyDZ6tWOk6Kh/exec";
/* ========================================================= */

const LS_KEY = "SLG_API_BASE_STABLE_V1";

const $ = (id) => document.getElementById(id);

$("execText").textContent = API_EXEC_FALLBACK;

let API_BASE = API_GOOGLEUSERCONTENT_BASE || "";        // æœƒè‡ªå‹•å–å¾—ç©©å®šå…¥å£ï¼ˆgoogleusercontentï¼‰
let questions = [];
const debugState = {
  sanitizedQuery: "ï¼ˆå°šæœªé€å‡ºæŸ¥è©¢ï¼‰",
  lastRequestUrl: "ï¼ˆå°šæœªé€å‡ºè«‹æ±‚ï¼‰",
  rawResponsePreview: "ï¼ˆå°šæœªé€å‡ºè«‹æ±‚ï¼‰",
  parsedCount: "ï¼ˆå°šæœªè§£æï¼‰",
  writtenSheetId: "ï¼ˆå°šæœªå¯«å…¥ï¼‰",
};
let progressState = { doneIds: [], updated_at: "" };
let lifetimeDone = 0;
let totalCountFromApi = 0;

function setStatus(msg, isError = false) {
  $("status").textContent = msg;
  $("status").className = "mt-3 text-sm " + (isError ? "text-rose-300" : "text-slate-300");
}

function formatError(err) {
  if (!err) return "æœªçŸ¥éŒ¯èª¤";
  if (err.httpStatus) return `HTTP ${err.httpStatus}ï¼š${err.message}`;
  return err.message || String(err);
}

function setApiBaseText() {
  $("apiBaseText").textContent = API_BASE || API_GOOGLEUSERCONTENT_BASE || "ï¼ˆå°šæœªå–å¾—ï¼‰";
}

function updateDebugDisplay(overrides = {}) {
  Object.assign(debugState, overrides);
  $("debugQuery").textContent = debugState.sanitizedQuery;
  $("debugLastRequestUrl").textContent = debugState.lastRequestUrl;
  $("debugRaw").textContent = debugState.rawResponsePreview;
  $("debugParsedCount").textContent = debugState.parsedCount;
  if ($("debugSheetId")) $("debugSheetId").textContent = debugState.writtenSheetId || "ï¼ˆå°šæœªå¯«å…¥ï¼‰";
}

function summarizeParsedCount(json) {
  const count = json?.count ?? json?.total ?? json?.total_count ?? json?.data?.count ?? "";
  const arrays = [
    json?.data,
    json?.questions,
    json?.items,
    json?.data?.questions,
    json?.data?.items,
  ];
  const dataLength = arrays.find((a) => Array.isArray(a))?.length ?? "";
  return `count=${count || "ï¼ˆç„¡ï¼‰"}ï¼Œdata.length=${dataLength || "ï¼ˆç„¡ï¼‰"}`;
}

function sanitizeFilterValue(input) {
  const trimmed = String(input ?? "").trim();
  if (!trimmed) return "";
  if (/^ä¾‹å¦‚/i.test(trimmed)) return "";
  return trimmed;
}

function sanitizeDifficulty(input) {
  const trimmed = sanitizeFilterValue(input);
  if (!trimmed) return "";
  if (trimmed.includes("/") && (/ä¾‹å¦‚/i.test(trimmed) || /easy\s*\/\s*normal|normal\s*\/\s*hard/i.test(trimmed))) {
    return "";
  }
  return trimmed;
}

function getUserId() {
  return $("user_id").value.trim() || "guest";
}

function getProgressKey() {
  return `slg_progress_${getUserId()}`;
}

function loadProgress() {
  try {
    const raw = localStorage.getItem(getProgressKey());
    if (!raw) return { doneIds: [], updated_at: "" };
    const parsed = JSON.parse(raw);
    return {
      doneIds: Array.isArray(parsed.done_ids) ? parsed.done_ids.map(String) : Array.isArray(parsed.doneIds) ? parsed.doneIds.map(String) : [],
      updated_at: parsed.updated_at || ""
    };
  } catch (_) {
    return { doneIds: [], updated_at: "" };
  }
}

function saveProgress() {
  progressState.updated_at = new Date().toISOString();
  localStorage.setItem(getProgressKey(), JSON.stringify({
    done_ids: progressState.doneIds,
    updated_at: progressState.updated_at,
  }));
  updateProgressUI();
}

function resetProgress() {
  progressState = { doneIds: [], updated_at: "" };
  localStorage.removeItem(getProgressKey());
  updateProgressUI();
}

function updateProgressUI() {
  $("progressTotal").textContent = totalCountFromApi || "-";
  $("progressSession").textContent = progressState.doneIds.length;
  $("progressLifetime").textContent = (lifetimeDone || lifetimeDone === 0) ? lifetimeDone : "-";

  const remaining = totalCountFromApi ? Math.max(totalCountFromApi - progressState.doneIds.length, 0) : 0;
  if (remaining === 0 && totalCountFromApi > 0) {
    $("progressHint").textContent = "å…¨éƒ¨é¡Œç›®éƒ½å®Œæˆäº†ï¼å¯æŒ‰ã€Œé‡æ–°é–‹å§‹ã€æ¸…ç©ºé€²åº¦ã€‚";
  } else {
    $("progressHint").textContent = remaining > 0 ? `å°šæœ‰ ${remaining} é¡Œæœªä½œç­”ï¼Œç³»çµ±æœƒå„ªå…ˆå‡ºæœªåšéçš„é¡Œç›®ã€‚` : "";
  }
}

function ensureProgressLoaded() {
  progressState = loadProgress();
  updateProgressUI();
}

function markQuestionDone(qId) {
  const id = String(qId || "");
  if (!id) return;
  if (!progressState.doneIds.includes(id)) {
    progressState.doneIds.push(id);
    saveProgress();
    if (questions.length) renderList(questions);
  } else {
    updateProgressUI();
  }
}

async function refreshLifetimeProgress() {
  try {
    const r = await callApi({
      method: "GET",
      query: { action: "getUserProgress", user_id: getUserId() },
      skipDebug: true,
    });
    lifetimeDone = Number(r.logs_count || 0);
    updateProgressUI();
  } catch (_) {
    // éœé»˜å¿½ç•¥ï¼Œdebug å€å¡Šå·²å¯æŸ¥è©¢ raw response
  }
}

async function ensureStableBase({ force = false } = {}) {
  if (!force && API_BASE && API_BASE.startsWith("https://script.googleusercontent.com/")) {
    setApiBaseText();
    return API_BASE;
  }

  if (!force && API_GOOGLEUSERCONTENT_BASE) {
    API_BASE = API_GOOGLEUSERCONTENT_BASE;
    localStorage.setItem(LS_KEY, API_BASE);
    setApiBaseText();
    return API_BASE;
  }

  if (!force) {
    const cached = localStorage.getItem(LS_KEY);
    if (cached && cached.startsWith("https://script.googleusercontent.com/")) {
      API_BASE = cached;
      setApiBaseText();
      return API_BASE;
    }
  }

  // é€é redirect è‡ªå‹•æŠ“åˆ° googleusercontent çš„æœ€çµ‚ URL
  setStatus("å–å¾—ç©©å®šå…¥å£ä¸­â€¦");
  const url = new URL(API_EXEC_FALLBACK);
  url.searchParams.set("action", "ping");
  url.searchParams.set("_", String(Date.now())); // é˜² cache

  let res;
  try {
    res = await fetch(url.toString(), { method: "GET", redirect: "follow" });
  } catch (e) {
    throw new Error("ç„¡æ³•é€£ç·šåˆ° API_EXEC_FALLBACKï¼ˆè«‹ç¢ºèªéƒ¨ç½²ç‚ºã€èª°éƒ½å¯å­˜å–ã€ï¼‰ï¼š " + e.message);
  }

  // fetch è¿½å®Œ redirect å¾Œï¼Œres.url å°±æœƒæ˜¯ googleusercontent çš„ç©©å®šå…¥å£
  const finalUrl = res.url || "";
  if (finalUrl.startsWith("https://script.googleusercontent.com/")) {
    // âœ… ç”¨ finalUrl ç•¶ API_BASEï¼Œä½†è¦æŠŠ query æ¸…ä¹¾æ·¨ï¼Œåªç•™ base
    API_BASE = finalUrl.split("?")[0] + "?" + (finalUrl.split("?")[1] ? finalUrl.split("?")[1].split("&").filter(s => s.startsWith("user_content_key=") || s.startsWith("lib=")).join("&") : "");
    localStorage.setItem(LS_KEY, API_BASE);
    setApiBaseText();
    setStatus("âœ… å·²å–å¾—ç©©å®šå…¥å£");
    return API_BASE;
  }

  // æœªå–å¾— googleusercontentï¼šç¶­æŒ google å…¥å£ç‚ºç©ºï¼Œå¾ŒçºŒå‘¼å«æœƒæ”¹ç”¨ exec å‚™æ´
  API_BASE = "";
  setApiBaseText();
  setStatus("âš ï¸ æœªå–å¾— googleusercontentï¼Œå¾ŒçºŒå°‡æ”¹ç”¨ exec å‚™æ´", true);
  return API_BASE;
}

async function callApiWithBase(base, { method = "GET", action, query = {}, payload, skipDebug = false } = {}) {
  if (!base) {
    throw new Error("ç¼ºå°‘ API base URL");
  }

  const url = new URL(base);
  if (action) url.searchParams.set("action", action);

  if (method === "GET" && !query._) {
    query._ = Date.now();
  }

  Object.entries(query).forEach(([k, v]) => {
    if (v !== "" && v !== undefined && v !== null) url.searchParams.set(k, v);
  });

  const finalUrl = url.toString();
  if (!skipDebug) {
    $("lastReq").textContent = finalUrl;
    updateDebugDisplay({ lastRequestUrl: finalUrl });
  }

  let res;
  try {
    res = await fetch(finalUrl, {
      method,
      headers: method === "POST" ? { "Content-Type": "application/json" } : undefined,
      body: method === "POST" ? JSON.stringify(payload || {}) : undefined,
    });
  } catch (e) {
    throw new Error("ç„¡æ³•é€£ç·šåˆ° APIï¼ˆ" + e.message + "ï¼‰");
  }

  const text = await res.text();
  if (!skipDebug) {
    updateDebugDisplay({ rawResponsePreview: text.slice(0, 300) || "ï¼ˆç©ºç™½å›æ‡‰ï¼‰" });
  }
  let json;
  try {
    json = text ? JSON.parse(text) : {};
  } catch (e) {
    const hint = text.slice(0, 200) || "ï¼ˆç©ºç™½å›æ‡‰ï¼‰";
    const err = new Error("API å›æ‡‰ä¸æ˜¯ JSONï¼š" + hint);
    err.httpStatus = res.status;
    throw err;
  }

  if (!res.ok) {
    const msg = json.error || json.message || res.statusText;
    const err = new Error(msg);
    err.httpStatus = res.status;
    throw err;
  }

  if (json.ok === false || json.status === "error") {
    const msg = json.message || json.error || "API å›å‚³éŒ¯èª¤";
    const err = new Error(msg);
    err.httpStatus = json.code || "";
    throw err;
  }

  if (!skipDebug) {
    updateDebugDisplay({ parsedCount: summarizeParsedCount(json) });
  }
  return json;
}

async function callApi(args) {
  const { skipExecFallback = false, skipDebug = false, ...rest } = args || {};

  // å…ˆç¢ºä¿æœ‰ API_BASEï¼ˆgoogleusercontentï¼‰ï¼Œè‹¥æ²’æœ‰æœƒåœ¨éœ€è¦æ™‚ä½¿ç”¨ exec å‚™æ´
  if (!API_BASE) await ensureStableBase();

  const primaryBase = API_BASE || API_GOOGLEUSERCONTENT_BASE;
  let primaryError = primaryBase ? null : new Error("å°šæœªè¨­å®š googleusercontent å…¥å£");

  if (primaryBase) {
    try {
      return await callApiWithBase(primaryBase, { ...rest, skipDebug });
    } catch (e) {
      primaryError = e;
    }
  }

  if (skipExecFallback) {
    if (primaryError) throw primaryError;
    throw new Error("ç„¡æ³•å–å¾— googleusercontent å…¥å£ï¼Œè«‹ç¨å¾Œå†è©¦");
  }

  setStatus("âš ï¸ ç©©å®šå…¥å£å¤±æ•—ï¼Œæ”¹ç”¨ exec å‚™æ´ï¼š" + formatError(primaryError), true);
  return await callApiWithBase(API_EXEC_FALLBACK, { ...rest, skipDebug });
}

async function fetchQuestionsWithFallback(query) {
  await ensureStableBase();

  const primaryBase = API_BASE || API_GOOGLEUSERCONTENT_BASE;
  let usedExec = false;
  let r1;

  try {
    if (!primaryBase) throw new Error("ç¼ºå°‘ç©©å®šå…¥å£");
    r1 = await callApiWithBase(primaryBase, { method: "GET", query });
  } catch (e) {
    usedExec = true;
    setStatus("âš ï¸ ç©©å®šå…¥å£å¤±æ•—ï¼Œæ”¹ç”¨ exec å‚™æ´ï¼š" + formatError(e), true);
    r1 = await callApiWithBase(API_EXEC_FALLBACK, { method: "GET", query });
  }

  const parsed1 = normalizeQuestionList(r1);

  if (parsed1.count === 0 && !usedExec) {
    const r2 = await callApiWithBase(API_EXEC_FALLBACK, { method: "GET", query });
    const parsed2 = normalizeQuestionList(r2);
    return { parsed: parsed2, usedExec: true, primaryCount: parsed1.count };
  }

  return { parsed: parsed1, usedExec };
}

function firstArrayCandidate(obj, paths) {
  for (const path of paths) {
    let cur = obj;
    let ok = true;
    for (const key of path) {
      if (cur && Object.prototype.hasOwnProperty.call(cur, key)) {
        cur = cur[key];
      } else {
        ok = false;
        break;
      }
    }
    if (ok && Array.isArray(cur)) return cur;
  }
  return [];
}

function normalizeQuestionList(resp) {
  const safeResp = resp ?? {};
  const listSource = Array.isArray(safeResp)
    ? safeResp
    : firstArrayCandidate(safeResp, [
        ["data"],
        ["questions"],
        ["items"],
        ["data", "questions"],
        ["data", "items"],
      ]);

  const normalized = listSource.map(normalizeQuestion);
  const count =
    safeResp.count ??
    safeResp.total ??
    safeResp.total_count ??
    safeResp.data?.count ??
    normalized.length;

  return { items: normalized, count };
}

function normalizeQuestion(q) {
  const optionsRaw = Array.isArray(q.options)
    ? q.options
    : String(q.options ?? q.choices ?? "")
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);

  const questionId = q.question_id ?? q.q_id ?? q.id ?? q.uuid ?? "";

  return {
    ...q,
    question_id: questionId,
    stem: q.stem ?? q.question ?? q.title ?? "",
    unit: q.unit ?? q.topic ?? q.category ?? "",
    difficulty: q.difficulty ?? q.level ?? "",
    options: optionsRaw,
  };
}

function pickOne() {
  if (!questions.length) return null;
  return questions[Math.floor(Math.random() * questions.length)];
}

function pickNextQuestionPreferFresh() {
  const undone = questions.filter(q => !progressState.doneIds.includes(String(q.question_id)));
  if (undone.length) return undone[Math.floor(Math.random() * undone.length)];
  return pickOne();
}

function handleLoadedQuestions(parsed, { usedExec = false } = {}) {
  questions = parsed.items;
  totalCountFromApi = parsed.count || parsed.items.length || 0;
  ensureProgressLoaded();
  refreshLifetimeProgress();
  updateProgressUI();
  renderList(questions);
  if (questions.length) {
    const next = pickNextQuestionPreferFresh();
    renderQuiz(next);
  } else {
    renderQuiz(null);
  }

  const suffix = usedExec ? "ï¼ˆä½¿ç”¨ exec å‚™æ´ï¼‰" : "";
  if (questions.length) {
    setStatus(`è¼‰å…¥æˆåŠŸï¼šå¾Œç«¯å›å‚³ ${parsed.count} é¡Œï¼Œå‰ç«¯é¡¯ç¤º ${questions.length} é¡Œ${suffix}`);
  } else {
    setStatus(`è¼‰å…¥çµæœç‚º 0 é¡Œ${suffix}`, true);
  }
}

function renderList(items) {
  $("list").innerHTML = "";
  const undone = items.filter((q) => !progressState.doneIds.includes(String(q.question_id)));
  $("count").textContent = items.length
    ? `å…± ${items.length} é¡Œï¼ˆç›®å‰é¡¯ç¤ºï¼‰ï¼Œæœªåšé ${undone.length} é¡Œ`
    : "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®";

  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "text-slate-400 text-sm";
    empty.textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ã€‚è«‹å…ˆæŠŠç¯©é¸æ¢ä»¶ç•™ç©ºè©¦è©¦ï¼Œæˆ–ç¢ºèª GAS å›å‚³çš„ difficulty å€¼ã€‚";
    $("list").appendChild(empty);
    $("quiz").classList.add("hidden");
    $("quiz").innerHTML = "";
    return;
  }

  items.forEach((q) => {
    const card = document.createElement("div");
    card.className = "p-4 border border-slate-800 rounded bg-slate-950/40";
    card.innerHTML = `
      <div class="font-semibold">${escapeHtml(q.stem || "")}</div>
      <div class="text-sm text-slate-300 mt-1">
        å¹´ç´š ${escapeHtml(String(q.grade ?? ""))}ï½œ${escapeHtml(q.unit || "")}ï½œ${escapeHtml(q.difficulty || "")}
      </div>
      <div class="mt-2 flex items-center gap-2">
        <button class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600">
          ä½œç­”
        </button>
        ${progressState.doneIds.includes(String(q.question_id)) ? '<span class="text-xs text-emerald-300">å·²å®Œæˆ</span>' : ""}
      </div>
    `;
    card.querySelector("button").onclick = () => renderQuiz(q);
    $("list").appendChild(card);
  });
}

function renderQuiz(q) {
  if (!q) {
    $("quiz").classList.add("hidden");
    $("quiz").innerHTML = "";
    return;
  }

  const quiz = $("quiz");
  quiz.classList.remove("hidden");

  const opts = (Array.isArray(q.options) ? q.options : [])
    .map((s) => String(s).trim())
    .filter(Boolean);

  const optHtml = opts.map((op, i) => `
    <label class="flex gap-2 p-2 border border-slate-800 rounded cursor-pointer">
      <input type="radio" name="opt" value="${i}">
      <span>${escapeHtml(op)}</span>
    </label>
  `).join("");

  quiz.innerHTML = `
    <div class="text-xl font-semibold mb-3">${escapeHtml(q.stem || "")}</div>
    <div class="space-y-2">${optHtml || `<div class="text-slate-300">æ­¤é¡Œ options æ¬„ä½æ˜¯ç©ºçš„</div>`}</div>

    <div class="mt-3 flex gap-2">
      <button id="submit" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">é€å‡º</button>
      <button id="next" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">æ›ä¸€é¡Œ</button>
    </div>

    <div id="result" class="mt-3 text-sm"></div>

    <details class="mt-3">
      <summary class="cursor-pointer text-slate-300">è§£æ</summary>
      <div class="mt-2 text-slate-200">${escapeHtml(q.explanation || "")}</div>
    </details>
  `;

  $("next").onclick = () => {
    if (!questions.length) return;
    renderQuiz(pickNextQuestionPreferFresh());
  };

  $("submit").onclick = async () => {
    const picked = quiz.querySelector('input[name="opt"]:checked');
    if (!picked) {
      $("result").textContent = "è«‹å…ˆé¸ä¸€å€‹ç­”æ¡ˆ";
      return;
    }

    const chosenIdx = Number(picked.value);
    const localCorrect = chosenIdx === Number(q.answer_key);
    const baseMessage = localCorrect ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼";
    const resultEl = $("result");
    resultEl.innerHTML = `<div class="font-semibold">${baseMessage}</div>`;

    const detail = quiz.querySelector("details");
    if (!localCorrect && detail) {
      detail.open = true;
    }

    const submissionQuery = {
      action: "submitAnswer",
      user_id: getUserId(),
      q_id: q.question_id,
      chosen_answer: chosenIdx,
    };
    updateDebugDisplay({ sanitizedQuery: JSON.stringify(submissionQuery, null, 2), parsedCount: "ï¼ˆå°šæœªè§£æï¼‰" });

    const recordStatus = document.createElement("div");
    recordStatus.className = "text-xs text-slate-300 mt-1";
    recordStatus.textContent = "èƒŒæ™¯ç´€éŒ„ä¸­â€¦";
    resultEl.appendChild(recordStatus);

    try {
      // æäº¤ç­”æ¡ˆå›ºå®šèµ° execï¼Œé¿å… JSON POST è§¸ç™¼ preflight
      const submitResp = await callApiWithBase(API_EXEC_FALLBACK, {
        method: "GET",
        query: submissionQuery,
      });

      const parts = [];
      if (submitResp.log_row) parts.push(`Logs ç¬¬ ${submitResp.log_row} åˆ—`);
      if (submitResp.logs_total) parts.push(`Logs ç¸½ç­†æ•¸ ${submitResp.logs_total}`);
      if (submitResp.log_timestamp) parts.push(`æ™‚é–“ ${submitResp.log_timestamp}`);
      if (submitResp.written_to_spreadsheet_id) parts.push(`sheet ${submitResp.written_to_spreadsheet_id}`);

      debugState.writtenSheetId = submitResp.written_to_spreadsheet_id || submitResp.spreadsheet_id || "ï¼ˆæœªå›å‚³ï¼‰";
      updateDebugDisplay();

      const serverExplanation = submitResp.explanation || q.explanation || "";
      if (!localCorrect && serverExplanation) {
        const explain = document.createElement("div");
        explain.className = "mt-2 text-slate-200";
        explain.innerHTML = `<div class="font-semibold text-amber-300">è§£æï¼š</div>${escapeHtml(serverExplanation)}`;
        resultEl.appendChild(explain);
      }

      let progressText = "";
      try {
        const progress = await callApi({
          method: "GET",
          query: { action: "getUserProgress", user_id: submissionQuery.user_id },
          skipDebug: true,
        });
        lifetimeDone = Number(progress.logs_count || 0);
        const checks = [];
        if (progress.logs_count !== undefined) checks.push(`Logs ${progress.logs_count}`);
        if (progress.mastery_count !== undefined) checks.push(`Mastery ${progress.mastery_count}`);
        if (progress.mistakes_count !== undefined) checks.push(`Mistakes ${progress.mistakes_count}`);
        if (progress.sheet_last_row) checks.push(`æœ€å¾Œåˆ— ${progress.sheet_last_row}`);
        if (checks.length) progressText = `ï¼ˆ${checks.join("ï¼Œ")}ï¼‰`;
      } catch (progressErr) {
        progressText = `ï¼ˆprogress æŸ¥è©¢å¤±æ•—ï¼š${formatError(progressErr)}ï¼‰`;
      }

      markQuestionDone(q.question_id);

      const detailText = parts.length ? parts.join("ï¼Œ") : "å·²å›å‚³å¯«å…¥è³‡è¨Š";
      recordStatus.textContent = `å·²è¨˜éŒ„ï¼š${detailText} ${progressText}`;
      recordStatus.className = "text-xs text-emerald-300 mt-1";

      const delay = 600 + Math.floor(Math.random() * 300);
      setTimeout(() => {
        if (!questions.length) return;
        const nextQ = pickNextQuestionPreferFresh();
        if (nextQ) {
          renderQuiz(nextQ);
        } else {
          setStatus("ç›®å‰æ²’æœ‰é¡Œç›®å¯å‡ºï¼Œè«‹é‡æ–°è¼‰å…¥æˆ–é‡æ–°é–‹å§‹ã€‚", true);
        }
      }, delay);
    } catch (e) {
      const hint = formatError(e);
      recordStatus.textContent = `æœªè¨˜éŒ„ï¼ˆä¸å½±éŸ¿æ¸¬é©—ï¼‰ã€‚è«‹é‡æ–°æ•´ç†æˆ–æ›ç¶²è·¯å†è©¦ã€‚${hint ? " è©³ç´°ï¼š" + hint : ""}`;
      recordStatus.className = "text-xs text-amber-300 mt-1";
    }
  };
}

function noFiltersApplied(filters) {
  return !filters.grade && !filters.unit && !filters.difficulty;
}

$("btnPing").onclick = async () => {
  try {
    setStatus("Ping ä¸­â€¦");
    await ensureStableBase(); // ç¢ºä¿ç©©å®šå…¥å£å­˜åœ¨
    const r = await callApi({ method: "GET", query: { action: "ping", _: Date.now() } });
    const msg = r.message || r.status || "pong";
    const ts = r.ts ? `ï¼ˆ${r.ts}ï¼‰` : "";
    setStatus(`API OKï¼š${msg}${ts}`);
  } catch (e) {
    setStatus("Ping å¤±æ•—ï¼š" + formatError(e), true);
  }
};

$("btnLoad").onclick = async () => {
  try {
    setStatus("è¼‰å…¥ä¸­â€¦");
    await ensureStableBase();

    const filters = {
      grade: sanitizeFilterValue($("grade").value),
      unit: sanitizeFilterValue($("unit").value),
      difficulty: sanitizeDifficulty($("difficulty").value),
    };

    const query = {
      action: "getQuestions",
      limit: 100,
      _: Date.now(),
    };

    if (filters.grade) query.grade = filters.grade;
    if (filters.unit) query.unit = filters.unit;
    if (filters.difficulty) query.difficulty = filters.difficulty;

    updateDebugDisplay({ sanitizedQuery: JSON.stringify(query, null, 2) });

    const { parsed, usedExec } = await fetchQuestionsWithFallback(query);
    handleLoadedQuestions(parsed, { usedExec });
  } catch (e) {
    setStatus("è¼‰å…¥å¤±æ•—ï¼š" + formatError(e), true);
    renderList([]);
  }
};

$("btnLoadAll").onclick = async () => {
  try {
    setStatus("è¼‰å…¥å…¨éƒ¨ä¸­â€¦");
    const query = { action: "getQuestions", limit: 100, _: Date.now() };
    updateDebugDisplay({ sanitizedQuery: JSON.stringify(query, null, 2) });
    const { parsed, usedExec } = await fetchQuestionsWithFallback(query);
    handleLoadedQuestions(parsed, { usedExec });
  } catch (e) {
    setStatus("è¼‰å…¥å…¨éƒ¨å¤±æ•—ï¼š" + formatError(e), true);
    renderList([]);
  }
};

$("btnRefreshStable").onclick = async () => {
  try {
    await ensureStableBase({ force: true });
    setStatus("âœ… å·²é‡æ–°å–å¾—ç©©å®šå…¥å£ï¼ˆè«‹å†æŒ‰ä¸€æ¬¡è¼‰å…¥é¡Œç›®ï¼‰");
  } catch (e) {
    setStatus("é‡æ–°å–å¾—å¤±æ•—ï¼š" + formatError(e), true);
  }
};

$("btnClearCache").onclick = () => {
  localStorage.removeItem(LS_KEY);
  API_BASE = API_GOOGLEUSERCONTENT_BASE || "";
  setApiBaseText();
  setStatus("å·²æ¸…é™¤ API å¿«å–ï¼ˆè«‹æŒ‰ Ping æˆ–é‡æ–°å–å¾—ç©©å®šå…¥å£ï¼‰");
};

$("btnSaveProgress").onclick = () => {
  saveProgress();
  setStatus("âœ… å·²ä¿å­˜æœ¬æ¬¡é€²åº¦");
};

$("btnResetProgress").onclick = () => {
  resetProgress();
  setStatus("å·²æ¸…ç©ºé€²åº¦ï¼Œå„ªå…ˆå‡ºæœªåšéé¡Œç›®ã€‚");
  if (questions.length) {
    renderQuiz(pickNextQuestionPreferFresh());
    renderList(questions);
  }
};

$("user_id").addEventListener("change", () => {
  ensureProgressLoaded();
  refreshLifetimeProgress();
  setStatus("å·²åˆ‡æ›ä½¿ç”¨è€…ï¼Œè«‹é‡æ–°è¼‰å…¥é¡Œç›®ä»¥æ›´æ–°é¡Œåº«ã€‚");
});

// é˜² XSSï¼šæŠŠé¡Œç›®æ–‡å­—å®‰å…¨è¼¸å‡º
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// åˆå§‹ï¼šå…ˆå˜—è©¦è¼‰å…¥å¿«å–çš„ç©©å®šå…¥å£
(async function init() {
  try {
    await ensureStableBase();
    ensureProgressLoaded();
    refreshLifetimeProgress();
  } catch (_) {
    // ä¸æ“‹ UIï¼Œä½¿ç”¨è€…å¯æ‰‹å‹• Ping
  }
})();
</script>
</body>
</html>
