<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science Learning Garden</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">

    <!-- ===== Header ===== -->
    <header class="mb-6">
      <h1 class="text-2xl font-semibold">ğŸŒ± Science Learning Garden</h1>
      <p class="text-slate-300 mt-2">
        GitHub Pages å‰ç«¯ Ã— Google Apps Script API Ã— Google Sheet é¡Œåº«
      </p>
    </header>

    <!-- ===== Controls ===== -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <div>
          <label class="block text-sm text-slate-300 mb-1">ä½¿ç”¨è€… ID</label>
          <input id="user_id" value="u001"
            class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">å¹´ç´š (grade)</label>
          <input id="grade" placeholder="ä¾‹å¦‚ 3"
            class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">å–®å…ƒ (unit)</label>
          <input id="unit" placeholder="ä¾‹å¦‚ æ¤ç‰©çš„æ§‹é€ "
            class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">é›£åº¦ (difficulty)</label>
          <input id="difficulty" placeholder="Normal"
            class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>
        <div class="flex items-end gap-2">
          <button id="btnPing"
            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">
            Ping API
          </button>
          <button id="btnLoad"
            class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-medium">
            è¼‰å…¥é¡Œç›®
          </button>
        </div>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-300"></div>
    </section>

    <!-- ===== Quiz ===== -->
    <section id="quiz"
      class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
    </section>

    <!-- ===== List ===== -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">é¡Œç›®æ¸…å–®</h2>
        <div id="count" class="text-sm text-slate-300"></div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
    </section>

  </div>

<script>
/* =========================================================
   ğŸ”§ è¨­å®šå€ï¼ˆä½ åªéœ€è¦ç¢ºèªé€™è£¡ï¼‰
========================================================= */
const API_BASE =
  "https://script.google.com/macros/s/AKfycbxy9T33HfqvChKFR8gVfNhS5DLT9lXprWC5cXCcBmRh4vSLr0r9jWIMnSREkApQpzXG/exec";

// è‹¥å¾Œç«¯ REQUIRE_KEY=trueï¼Œå¡«å…¥åŒä¸€ä¸²ï¼›å¦å‰‡ç•™ç©º ""
const API_KEY = "";

/* ========================================================= */

const $ = (id) => document.getElementById(id);
let questions = [];
let current = null;

function setStatus(msg, isError=false) {
  $("status").textContent = msg;
  $("status").className =
    "mt-3 text-sm " + (isError ? "text-rose-300" : "text-slate-300");
}

async function apiGet(params) {
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v]) => {
    if (v !== "" && v !== undefined && v !== null)
      url.searchParams.set(k, v);
  });
  if (API_KEY) url.searchParams.set("key", API_KEY);

  const res = await fetch(url.toString());
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "API error");
  return json;
}

async function apiSubmitAnswer(payload) {
  const url = new URL(API_BASE);
  url.searchParams.set("action", "submitAnswer");
  if (API_KEY) url.searchParams.set("key", API_KEY);

  const res = await fetch(url.toString(), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "API error");
  return json;
}

function pickOne() {
  return questions[Math.floor(Math.random() * questions.length)];
}

function renderQuiz(q) {
  current = q;
  const quiz = $("quiz");
  quiz.classList.remove("hidden");

  const options = String(q.options).split(",").map(s=>s.trim());

  quiz.innerHTML = `
    <div class="text-xl font-semibold mb-3">${q.stem}</div>
    <div class="space-y-2">
      ${options.map((op,i)=>`
        <label class="flex gap-2 p-2 border border-slate-800 rounded cursor-pointer">
          <input type="radio" name="opt" value="${i}" />
          <span>${op}</span>
        </label>`).join("")}
    </div>
    <div class="mt-3 flex gap-2">
      <button id="submit"
        class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">
        é€å‡º
      </button>
      <button id="next"
        class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">
        æ›ä¸€é¡Œ
      </button>
    </div>
    <div id="result" class="mt-3 text-sm"></div>
    <details class="mt-3">
      <summary class="cursor-pointer text-slate-300">è§£æ</summary>
      <div class="mt-2 text-slate-200">${q.explanation || ""}</div>
    </details>
  `;

  $("next").onclick = () => renderQuiz(pickOne());

  $("submit").onclick = async () => {
    const picked = quiz.querySelector("input[name=opt]:checked");
    if (!picked) {
      $("result").textContent = "è«‹é¸æ“‡ç­”æ¡ˆ";
      return;
    }
    try {
      const res = await apiSubmitAnswer({
        user_id: $("user_id").value,
        q_id: q.question_id,
        chosen_answer: picked.value
      });
      $("result").textContent =
        res.is_correct ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†";
    } catch (e) {
      $("result").textContent = "é€å‡ºå¤±æ•—ï¼š" + e.message;
    }
  };
}

function renderList(items) {
  $("list").innerHTML = "";
  $("count").textContent = `å…± ${items.length} é¡Œ`;

  items.forEach(q => {
    const card = document.createElement("div");
    card.className =
      "p-4 border border-slate-800 rounded bg-slate-950/40";
    card.innerHTML = `
      <div class="font-semibold">${q.stem}</div>
      <div class="text-sm text-slate-300 mt-1">
        å¹´ç´š ${q.grade}ï½œ${q.unit}ï½œ${q.difficulty}
      </div>
      <button class="mt-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600">
        ä½œç­”
      </button>`;
    card.querySelector("button").onclick = () => renderQuiz(q);
    $("list").appendChild(card);
  });
}

/* ===== Buttons ===== */

$("btnPing").onclick = async () => {
  try {
    const r = await apiGet({ action:"ping" });
    setStatus("API OKï¼š" + r.message);
  } catch (e) {
    setStatus("Ping å¤±æ•—ï¼š" + e.message, true);
  }
};

$("btnLoad").onclick = async () => {
  try {
    setStatus("è¼‰å…¥ä¸­â€¦");
    const r = await apiGet({
      action: "getQuestions",
      grade: $("grade").value,
      unit: $("unit").value,
      difficulty: $("difficulty").value,
      limit: 100
    });
    questions = r.data;
    renderList(questions);
    renderQuiz(pickOne());
    setStatus(`è¼‰å…¥æˆåŠŸï¼Œå…± ${r.count} é¡Œ`);
  } catch (e) {
    setStatus("è¼‰å…¥å¤±æ•—ï¼š" + e.message, true);
  }
};
</script>
</body>
</html>
