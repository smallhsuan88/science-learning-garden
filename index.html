<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science Learning Garden</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-2xl font-semibold">ğŸŒ± Science Learning Garden</h1>
      <p class="text-slate-300 mt-2">GitHub Pages å‰ç«¯ Ã— Google Apps Script API Ã— Google Sheet é¡Œåº«</p>
    </header>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-300 mb-1">ä½¿ç”¨è€… ID</label>
          <input id="user_id" value="u001"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å¹´ç´š (grade)</label>
          <input id="grade" placeholder="ä¾‹å¦‚ 3"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å–®å…ƒ (unit)</label>
          <input id="unit" placeholder="ä¾‹å¦‚ æ¤ç‰©çš„æ§‹é€ "
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">é›£åº¦ (difficulty)</label>
          <input id="difficulty" placeholder="Normal"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div class="flex items-end gap-2">
          <button id="btnPing"
            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">
            Ping API
          </button>
          <button id="btnLoad"
            class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-medium">
            è¼‰å…¥é¡Œç›®
          </button>
        </div>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-300"></div>
      <div class="mt-2 text-xs text-slate-400 break-all">
        API_BASEï¼š<span id="apiBaseText"></span>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6"></section>

    <!-- List -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">é¡Œç›®æ¸…å–®</h2>
        <div id="count" class="text-sm text-slate-300"></div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
    </section>
  </div>

<script>
/* =========================================================
   âœ… ç©©å®šå…¥å£ï¼šscript.googleusercontent.comï¼ˆä¸æ€•é‡æ–°éƒ¨ç½²ï¼‰
========================================================= */
const API_BASE = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgv-swuIEAMEZ4ObKa69POPZ1fUK7x-7M50kThZQZhwDk0pVda91HpmJg8_3sHPqJVzDC3RNsZ2zj6h60FsWTrNX-ColjjV1O6UcaWPVehK7QmvWWoXcPeO4dotZp8hFSv5tiQRsMSnWWOB-ylomHilrNrZgOQP_jr0DP5X5HZymnCQ1okmMMhMDjSQBHCyAG0B65MkjpWTb2DOjzVeGSRTa_uHCzuoJPsHdTBasg9NNUOgbz10_4NpIVjVRFRBYAUdfqNcJM0bOL4cySVgyH6C656RXQ&lib=MXyviE2JblIqahjsM4_azJF8SLOz3GMtV";
/* ========================================================= */

const $ = (id) => document.getElementById(id);
$("apiBaseText").textContent = API_BASE;

let questions = [];
let current = null;

function setStatus(msg, isError=false) {
  $("status").textContent = msg;
  $("status").className = "mt-3 text-sm " + (isError ? "text-rose-300" : "text-slate-300");
}

async function apiGet(params) {
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v]) => {
    if (v !== "" && v !== undefined && v !== null) url.searchParams.set(k, v);
  });
  const res = await fetch(url.toString(), { method: "GET" });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "API error");
  return json;
}

async function apiPost(action, payload) {
  const url = new URL(API_BASE);
  url.searchParams.set("action", action);
  const res = await fetch(url.toString(), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload || {})
  });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "API error");
  return json;
}

function pickOne() {
  return questions[Math.floor(Math.random() * questions.length)];
}

function renderList(items) {
  $("list").innerHTML = "";
  $("count").textContent = `å…± ${items.length} é¡Œï¼ˆç›®å‰é¡¯ç¤ºï¼‰`;

  items.forEach(q => {
    const card = document.createElement("div");
    card.className = "p-4 border border-slate-800 rounded bg-slate-950/40";
    card.innerHTML = `
      <div class="font-semibold">${escapeHtml(q.stem || "")}</div>
      <div class="text-sm text-slate-300 mt-1">
        å¹´ç´š ${escapeHtml(String(q.grade ?? ""))}ï½œ${escapeHtml(q.unit || "")}ï½œ${escapeHtml(q.difficulty || "")}
      </div>
      <button class="mt-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600">
        ä½œç­”
      </button>
    `;
    card.querySelector("button").onclick = () => renderQuiz(q);
    $("list").appendChild(card);
  });
}

function renderQuiz(q) {
  current = q;
  const quiz = $("quiz");
  quiz.classList.remove("hidden");

  const opts = String(q.options || "").split(",").map(s => s.trim()).filter(Boolean);
  const optHtml = opts.map((op, i) => `
    <label class="flex gap-2 p-2 border border-slate-800 rounded cursor-pointer">
      <input type="radio" name="opt" value="${i}">
      <span>${escapeHtml(op)}</span>
    </label>
  `).join("");

  quiz.innerHTML = `
    <div class="text-xl font-semibold mb-3">${escapeHtml(q.stem || "")}</div>
    <div class="space-y-2">${optHtml || `<div class="text-slate-300">æ­¤é¡Œ options æ¬„ä½æ˜¯ç©ºçš„</div>`}</div>

    <div class="mt-3 flex gap-2">
      <button id="submit" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">é€å‡º</button>
      <button id="next" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">æ›ä¸€é¡Œ</button>
    </div>

    <div id="result" class="mt-3 text-sm"></div>

    <details class="mt-3">
      <summary class="cursor-pointer text-slate-300">è§£æ</summary>
      <div class="mt-2 text-slate-200">${escapeHtml(q.explanation || "")}</div>
    </details>
  `;

  $("next").onclick = () => {
    if (!questions.length) return;
    renderQuiz(pickOne());
  };

  $("submit").onclick = async () => {
    const picked = quiz.querySelector('input[name="opt"]:checked');
    if (!picked) return ($("result").textContent = "è«‹å…ˆé¸ä¸€å€‹ç­”æ¡ˆ");

    try {
      $("result").textContent = "é€å‡ºä¸­â€¦";

      // ä½ å¾Œç«¯è‹¥ action åç¨±ä¸åŒï¼ŒæŠŠ "submitAnswer" æ”¹æˆä½ çš„
      const r = await apiPost("submitAnswer", {
        user_id: $("user_id").value.trim(),
        q_id: q.question_id,
        chosen_answer: Number(picked.value)
      });

      // ä½ å¾Œç«¯å›å‚³æ¬„ä½è‹¥ä¸åŒï¼Œé€™è£¡å¯èª¿æ•´
      const ok = !!r.is_correct;
      $("result").textContent = ok ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼";
    } catch (e) {
      $("result").textContent = "é€å‡ºå¤±æ•—ï¼š" + e.message;
    }
  };
}

$("btnPing").onclick = async () => {
  try {
    setStatus("Ping ä¸­â€¦");
    const r = await apiGet({ action: "ping" });
    setStatus(`API OKï¼š${r.message}ï¼ˆ${r.ts}ï¼‰`);
  } catch (e) {
    setStatus("Ping å¤±æ•—ï¼š" + e.message, true);
  }
};

$("btnLoad").onclick = async () => {
  try {
    setStatus("è¼‰å…¥ä¸­â€¦");
    const r = await apiGet({
      action: "getQuestions",
      grade: $("grade").value.trim(),
      unit: $("unit").value.trim(),
      difficulty: $("difficulty").value.trim(),
      limit: 100
    });

    questions = Array.isArray(r.data) ? r.data : [];
    renderList(questions);

    if (questions.length) renderQuiz(pickOne());
    setStatus(`è¼‰å…¥æˆåŠŸï¼šå…± ${r.count ?? questions.length} é¡Œ`);
  } catch (e) {
    setStatus("è¼‰å…¥å¤±æ•—ï¼š" + e.message, true);
  }
};

// é˜² XSSï¼šæŠŠé¡Œç›®æ–‡å­—å®‰å…¨è¼¸å‡º
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
