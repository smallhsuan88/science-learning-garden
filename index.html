<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science Learning Garden</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-2xl font-semibold">ğŸŒ± Science Learning Garden</h1>
      <p class="text-slate-300 mt-2">GitHub Pages å‰ç«¯ Ã— Google Apps Script API Ã— Google Sheet é¡Œåº«</p>
    </header>

    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-300 mb-1">ä½¿ç”¨è€… ID</label>
          <input id="user_id" value="u001"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å¹´ç´š (grade)</label>
          <input id="grade" placeholder="ä¾‹å¦‚ 1 / 2 / 3"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">å–®å…ƒ (unit)</label>
          <input id="unit" placeholder="ä¾‹å¦‚ æ¤ç‰©çš„æ§‹é€ "
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">é›£åº¦ (difficulty)</label>
          <!-- âœ… é è¨­ç©ºç™½ï¼Œé¿å…ä¸€é–‹å§‹å°±æŠŠé¡Œç›®ç¯©å…‰ -->
          <input id="difficulty" placeholder="ä¾‹å¦‚ Easy / Normal / Hardï¼ˆå¯ç•™ç©ºï¼‰"
                 class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800" />
        </div>

        <div class="flex items-end gap-2">
          <button id="btnPing"
            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">
            Ping API
          </button>
          <button id="btnLoad"
            class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-medium">
            è¼‰å…¥é¡Œç›®
          </button>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnRefreshStable"
          class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          é‡æ–°å–å¾—ç©©å®šå…¥å£
        </button>
        <button id="btnClearCache"
          class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          æ¸…é™¤ API å¿«å–
        </button>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-300"></div>

      <div class="mt-2 text-xs text-slate-400 break-all space-y-1">
        <div>API_BASEï¼ˆå¯¦éš›å‘¼å«ç”¨ï¼‰ï¼š<span id="apiBaseText"></span></div>
        <div>FALLBACK_EXECï¼ˆå‚™æ´ï¼‰ï¼š<span id="execText"></span></div>
        <div>æœ€è¿‘ä¸€æ¬¡è«‹æ±‚ï¼š<span id="lastReq"></span></div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-4 mb-6"></section>

    <!-- List -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">é¡Œç›®æ¸…å–®</h2>
        <div id="count" class="text-sm text-slate-300"></div>
      </div>
      <div id="list" class="mt-3 space-y-3"></div>
    </section>
  </div>

<script>
/* =========================================================
   âœ… ä½ åªéœ€è¦æ”¹é€™ä¸€è¡Œï¼šæœ€æ–°éƒ¨ç½²çš„ exec URL
========================================================= */
const EXEC_URL = "https://script.google.com/macros/s/AKfycbyouH4rIopFTOQIPcoKosIFIwwd3wi9kvernE3D7lVWuFZp8BCoG8bC6fwIrsFUEVAF/exec";
/* ========================================================= */

const LS_KEY = "SLG_API_BASE_STABLE_V1";

const $ = (id) => document.getElementById(id);

$("execText").textContent = EXEC_URL;

let API_BASE = "";        // æœƒè‡ªå‹•å–å¾—ç©©å®šå…¥å£ï¼ˆgoogleusercontentï¼‰
let questions = [];

function setStatus(msg, isError = false) {
  $("status").textContent = msg;
  $("status").className = "mt-3 text-sm " + (isError ? "text-rose-300" : "text-slate-300");
}

function formatError(err) {
  if (!err) return "æœªçŸ¥éŒ¯èª¤";
  if (err.httpStatus) return `HTTP ${err.httpStatus}ï¼š${err.message}`;
  return err.message || String(err);
}

function setApiBaseText() {
  $("apiBaseText").textContent = API_BASE || "ï¼ˆå°šæœªå–å¾—ï¼‰";
}

async function ensureStableBase({ force = false } = {}) {
  if (!force) {
    const cached = localStorage.getItem(LS_KEY);
    if (cached && cached.startsWith("https://script.googleusercontent.com/")) {
      API_BASE = cached;
      setApiBaseText();
      return API_BASE;
    }
  }

  // é€é redirect è‡ªå‹•æŠ“åˆ° googleusercontent çš„æœ€çµ‚ URL
  setStatus("å–å¾—ç©©å®šå…¥å£ä¸­â€¦");
  const url = new URL(EXEC_URL);
  url.searchParams.set("action", "ping");
  url.searchParams.set("_", String(Date.now())); // é˜² cache

  let res;
  try {
    res = await fetch(url.toString(), { method: "GET", redirect: "follow" });
  } catch (e) {
    throw new Error("ç„¡æ³•é€£ç·šåˆ° EXEC_URLï¼ˆè«‹ç¢ºèªéƒ¨ç½²ç‚ºã€èª°éƒ½å¯å­˜å–ã€ï¼‰ï¼š " + e.message);
  }

  // fetch è¿½å®Œ redirect å¾Œï¼Œres.url å°±æœƒæ˜¯ googleusercontent çš„ç©©å®šå…¥å£
  const finalUrl = res.url;
  if (!finalUrl || !finalUrl.startsWith("https://script.googleusercontent.com/")) {
    // æœ‰äº›æƒ…æ³å¯èƒ½ä¸æœƒ redirectï¼ˆä½†è‡³å°‘é‚„èƒ½ç”¨ execï¼‰
    API_BASE = EXEC_URL;
    localStorage.setItem(LS_KEY, API_BASE);
    setApiBaseText();
    setStatus("âš ï¸ æœªå–å¾— googleusercontentï¼Œæš«ç”¨ exec ç›´é€£ï¼ˆä»å¯é‹ä½œï¼‰");
    return API_BASE;
  }

  // âœ… ç”¨ finalUrl ç•¶ API_BASEï¼Œä½†è¦æŠŠ query æ¸…ä¹¾æ·¨ï¼Œåªç•™ base
  // finalUrl å¯èƒ½å·²ç¶“å¸¶ action=ping ç­‰åƒæ•¸ï¼Œæˆ‘å€‘åªå– origin+path+search ä¸­çš„å¿…è¦åŸºåº•
  // æœ€ä¿éšªåšæ³•ï¼šç”¨ finalUrl ç•¶ baseï¼Œå¾ŒçºŒç”¨ URL() å† append action/paramsã€‚
  API_BASE = finalUrl.split("?")[0] + "?" + (finalUrl.split("?")[1] ? finalUrl.split("?")[1].split("&").filter(s => s.startsWith("user_content_key=") || s.startsWith("lib=")).join("&") : "");
  localStorage.setItem(LS_KEY, API_BASE);
  setApiBaseText();
  setStatus("âœ… å·²å–å¾—ç©©å®šå…¥å£");
  return API_BASE;
}

async function callApiWithBase(base, { method = "GET", action, query = {}, payload } = {}) {
  const url = new URL(base);
  if (action) url.searchParams.set("action", action);

  Object.entries(query).forEach(([k, v]) => {
    if (v !== "" && v !== undefined && v !== null) url.searchParams.set(k, v);
  });

  $("lastReq").textContent = url.toString();

  let res;
  try {
    res = await fetch(url.toString(), {
      method,
      headers: method === "POST" ? { "Content-Type": "application/json" } : undefined,
      body: method === "POST" ? JSON.stringify(payload || {}) : undefined,
    });
  } catch (e) {
    throw new Error("ç„¡æ³•é€£ç·šåˆ° APIï¼ˆ" + e.message + "ï¼‰");
  }

  const text = await res.text();
  let json;
  try {
    json = text ? JSON.parse(text) : {};
  } catch (e) {
    const hint = text.slice(0, 200) || "ï¼ˆç©ºç™½å›æ‡‰ï¼‰";
    const err = new Error("API å›æ‡‰ä¸æ˜¯ JSONï¼š" + hint);
    err.httpStatus = res.status;
    throw err;
  }

  if (!res.ok) {
    const msg = json.error || json.message || res.statusText;
    const err = new Error(msg);
    err.httpStatus = res.status;
    throw err;
  }

  if (json.ok === false || json.status === "error") {
    const msg = json.message || json.error || "API å›å‚³éŒ¯èª¤";
    const err = new Error(msg);
    err.httpStatus = json.code || "";
    throw err;
  }

  return json;
}

async function callApi(args) {
  // å…ˆç¢ºä¿æœ‰ API_BASE
  if (!API_BASE) await ensureStableBase();

  // å…ˆæ‰“ç©©å®šå…¥å£
  try {
    return await callApiWithBase(API_BASE, args);
  } catch (e) {
    // ç©©å®šå…¥å£æ›äº†å°±ç›´æ¥æ”¹ç”¨ exec
    setStatus("âš ï¸ ç©©å®šå…¥å£å¤±æ•—ï¼Œæ”¹ç”¨ exec å‚™æ´ï¼š" + formatError(e), true);
    return await callApiWithBase(EXEC_URL, args);
  }
}

function firstArrayCandidate(obj, paths) {
  for (const path of paths) {
    let cur = obj;
    let ok = true;
    for (const key of path) {
      if (cur && Object.prototype.hasOwnProperty.call(cur, key)) {
        cur = cur[key];
      } else {
        ok = false;
        break;
      }
    }
    if (ok && Array.isArray(cur)) return cur;
  }
  return [];
}

function normalizeQuestionList(resp) {
  const safeResp = resp ?? {};
  const listSource = Array.isArray(safeResp)
    ? safeResp
    : firstArrayCandidate(safeResp, [
        ["data"],
        ["questions"],
        ["items"],
        ["data", "questions"],
        ["data", "items"],
      ]);

  const normalized = listSource.map(normalizeQuestion);
  const count =
    safeResp.count ??
    safeResp.total ??
    safeResp.total_count ??
    safeResp.data?.count ??
    normalized.length;

  return { items: normalized, count };
}

function normalizeQuestion(q) {
  const optionsRaw = Array.isArray(q.options)
    ? q.options
    : String(q.options ?? q.choices ?? "")
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);

  const questionId = q.question_id ?? q.q_id ?? q.id ?? q.uuid ?? "";

  return {
    ...q,
    question_id: questionId,
    stem: q.stem ?? q.question ?? q.title ?? "",
    unit: q.unit ?? q.topic ?? q.category ?? "",
    difficulty: q.difficulty ?? q.level ?? "",
    options: optionsRaw,
  };
}

function pickOne() {
  return questions[Math.floor(Math.random() * questions.length)];
}

function renderList(items) {
  $("list").innerHTML = "";
  $("count").textContent = items.length
    ? `å…± ${items.length} é¡Œï¼ˆç›®å‰é¡¯ç¤ºï¼‰`
    : "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®";

  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "text-slate-400 text-sm";
    empty.textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ã€‚è«‹å…ˆæŠŠç¯©é¸æ¢ä»¶ç•™ç©ºè©¦è©¦ï¼Œæˆ–ç¢ºèª GAS å›å‚³çš„ difficulty å€¼ã€‚";
    $("list").appendChild(empty);
    $("quiz").classList.add("hidden");
    $("quiz").innerHTML = "";
    return;
  }

  items.forEach((q) => {
    const card = document.createElement("div");
    card.className = "p-4 border border-slate-800 rounded bg-slate-950/40";
    card.innerHTML = `
      <div class="font-semibold">${escapeHtml(q.stem || "")}</div>
      <div class="text-sm text-slate-300 mt-1">
        å¹´ç´š ${escapeHtml(String(q.grade ?? ""))}ï½œ${escapeHtml(q.unit || "")}ï½œ${escapeHtml(q.difficulty || "")}
      </div>
      <button class="mt-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600">
        ä½œç­”
      </button>
    `;
    card.querySelector("button").onclick = () => renderQuiz(q);
    $("list").appendChild(card);
  });
}

function renderQuiz(q) {
  const quiz = $("quiz");
  quiz.classList.remove("hidden");

  const opts = (Array.isArray(q.options) ? q.options : [])
    .map((s) => String(s).trim())
    .filter(Boolean);

  const optHtml = opts.map((op, i) => `
    <label class="flex gap-2 p-2 border border-slate-800 rounded cursor-pointer">
      <input type="radio" name="opt" value="${i}">
      <span>${escapeHtml(op)}</span>
    </label>
  `).join("");

  quiz.innerHTML = `
    <div class="text-xl font-semibold mb-3">${escapeHtml(q.stem || "")}</div>
    <div class="space-y-2">${optHtml || `<div class="text-slate-300">æ­¤é¡Œ options æ¬„ä½æ˜¯ç©ºçš„</div>`}</div>

    <div class="mt-3 flex gap-2">
      <button id="submit" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">é€å‡º</button>
      <button id="next" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">æ›ä¸€é¡Œ</button>
    </div>

    <div id="result" class="mt-3 text-sm"></div>

    <details class="mt-3">
      <summary class="cursor-pointer text-slate-300">è§£æ</summary>
      <div class="mt-2 text-slate-200">${escapeHtml(q.explanation || "")}</div>
    </details>
  `;

  $("next").onclick = () => {
    if (!questions.length) return;
    renderQuiz(pickOne());
  };

  $("submit").onclick = async () => {
    const picked = quiz.querySelector('input[name="opt"]:checked');
    if (!picked) {
      $("result").textContent = "è«‹å…ˆé¸ä¸€å€‹ç­”æ¡ˆ";
      return;
    }

    try {
      $("result").textContent = "é€å‡ºä¸­â€¦";

      const r = await callApi({
        method: "POST",
        action: "submitAnswer",
        payload: {
          user_id: $("user_id").value.trim(),
          q_id: q.question_id,
          chosen_answer: Number(picked.value),
        },
      });

      const ok = !!(r.is_correct ?? r.correct ?? r.ok);
      $("result").textContent = ok ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼";
    } catch (e) {
      $("result").textContent = "é€å‡ºå¤±æ•—ï¼š" + formatError(e);
    }
  };
}

function noFiltersApplied() {
  return !$("grade").value.trim() && !$("unit").value.trim() && !$("difficulty").value.trim();
}

$("btnPing").onclick = async () => {
  try {
    setStatus("Ping ä¸­â€¦");
    await ensureStableBase(); // ç¢ºä¿ç©©å®šå…¥å£å­˜åœ¨
    const r = await callApi({ method: "GET", query: { action: "ping", _: Date.now() } });
    const msg = r.message || r.status || "pong";
    const ts = r.ts ? `ï¼ˆ${r.ts}ï¼‰` : "";
    setStatus(`API OKï¼š${msg}${ts}`);
  } catch (e) {
    setStatus("Ping å¤±æ•—ï¼š" + formatError(e), true);
  }
};

$("btnLoad").onclick = async () => {
  try {
    setStatus("è¼‰å…¥ä¸­â€¦");
    await ensureStableBase();

    const query = {
      action: "getQuestions",
      grade: $("grade").value.trim(),
      unit: $("unit").value.trim(),
      difficulty: $("difficulty").value.trim(),
      limit: 100,
      _: Date.now()
    };

    // å…ˆç”¨ç©©å®šå…¥å£æ‰“
    const r1 = await callApiWithBase(API_BASE, { method: "GET", query });
    const parsed1 = normalizeQuestionList(r1);

    // âœ… è‹¥æ²’å¡«ç¯©é¸æ¢ä»¶ï¼Œä½†å›ä¾† 0 é¡Œ â†’ é«˜æ©Ÿç‡ç©©å®šå…¥å£æŒ‡åˆ°èˆŠéƒ¨ç½²ï¼Œæ”¹ç”¨ exec å†æ‰“ä¸€æ¬¡
    if (noFiltersApplied() && parsed1.count === 0) {
      const r2 = await callApiWithBase(EXEC_URL, { method: "GET", query });
      const parsed2 = normalizeQuestionList(r2);

      if (parsed2.count > 0) {
        // ç›´æ¥ç”¨ exec çš„è³‡æ–™å‘ˆç¾ï¼Œä¸¦æç¤ºä½ è©²åˆ·æ–°ç©©å®šå…¥å£
        questions = parsed2.items;
        renderList(questions);
        if (questions.length) renderQuiz(pickOne());
        setStatus(`âš ï¸ ç©©å®šå…¥å£å› 0 é¡Œï¼Œä½† exec æœ‰ ${parsed2.count} é¡Œã€‚è«‹æŒ‰ã€Œé‡æ–°å–å¾—ç©©å®šå…¥å£ã€ä¿®æ­£ã€‚`, true);
        return;
      }
    }

    questions = parsed1.items;
    renderList(questions);
    if (questions.length) renderQuiz(pickOne());

    setStatus(`è¼‰å…¥æˆåŠŸï¼šå¾Œç«¯å›å‚³ ${parsed1.count} é¡Œï¼Œå‰ç«¯é¡¯ç¤º ${questions.length} é¡Œ`);
  } catch (e) {
    setStatus("è¼‰å…¥å¤±æ•—ï¼š" + formatError(e), true);
    renderList([]);
  }
};

$("btnRefreshStable").onclick = async () => {
  try {
    await ensureStableBase({ force: true });
    setStatus("âœ… å·²é‡æ–°å–å¾—ç©©å®šå…¥å£ï¼ˆè«‹å†æŒ‰ä¸€æ¬¡è¼‰å…¥é¡Œç›®ï¼‰");
  } catch (e) {
    setStatus("é‡æ–°å–å¾—å¤±æ•—ï¼š" + formatError(e), true);
  }
};

$("btnClearCache").onclick = () => {
  localStorage.removeItem(LS_KEY);
  API_BASE = "";
  setApiBaseText();
  setStatus("å·²æ¸…é™¤ API å¿«å–ï¼ˆè«‹æŒ‰ Ping æˆ–é‡æ–°å–å¾—ç©©å®šå…¥å£ï¼‰");
};

// é˜² XSSï¼šæŠŠé¡Œç›®æ–‡å­—å®‰å…¨è¼¸å‡º
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// åˆå§‹ï¼šå…ˆå˜—è©¦è¼‰å…¥å¿«å–çš„ç©©å®šå…¥å£
(async function init() {
  try {
    await ensureStableBase();
  } catch (_) {
    // ä¸æ“‹ UIï¼Œä½¿ç”¨è€…å¯æ‰‹å‹• Ping
  }
})();
</script>
</body>
</html>
